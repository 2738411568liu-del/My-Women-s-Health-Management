<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å¥³æ€§å¥åº·ç®¡ç†ç³»ç»Ÿï¼ˆFirebase ç‰ˆï¼Œæ— ç™»å½•ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ä½¿ç”¨ Firebase v10 compat ç‰ˆæœ¬ï¼Œä»…ç”¨ App + Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
    }
    body {
      margin: 0;
      background: #f5f6fa;
      color: #333;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }
    h1, h2, h3 {
      margin-top: 0;
    }
    .card {
      background: #fff;
      border-radius: 14px;
      padding: 18px 18px 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
      margin-bottom: 16px;
    }
    .tagline {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #dfe4ff;
      color: #3b4cca;
      font-size: 11px;
      margin-left: 6px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
    }
    .col-2 { flex: 2; min-width: 260px; }
    .col-1 { flex: 1; min-width: 260px; }

    .form-group {
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 13px;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    input[type="checkbox"] {
      width: auto;
      margin-right: 4px;
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
      font-size: 12px;
    }
    .checkbox-group label {
      margin-bottom: 0;
    }
    button {
      border-radius: 999px;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      font-size: 13px;
    }
    .btn-primary {
      background: #4b7bec;
      color: #fff;
    }
    .btn-secondary {
      background: #f1f2f6;
      color: #333;
    }
    .btn-small {
      padding: 4px 10px;
      font-size: 12px;
    }
    .hidden {
      display: none;
    }
    .alert {
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .alert-info { background: #e9f5ff; color: #1e90ff; }
    .alert-success { background: #e7f9ed; color: #20bf6b; }
    .alert-error { background: #ffe9ec; color: #eb3b5a; }
    .small-text { font-size: 11px; color: #777; }

    .section-title {
      font-weight: 600;
      margin: 10px 0 4px;
      font-size: 14px;
    }
    .pill {
      display: inline-block;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f1f2f6;
      margin-right: 4px;
      margin-top: 2px;
    }
    .reminder-item {
      font-size: 12px;
      margin-bottom: 4px;
    }
    .reminder-strong {
      color: #eb3b5a;
      font-weight: 600;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 4px;
    }
    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #f1f2f6;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- é¡¶éƒ¨è¯´æ˜ -->
  <div class="card">
    <div class="tagline">
      âš  æœ¬ç³»ç»Ÿä»…ç”¨äºå­¦ä¹ ä¸ç ”ç©¶ç¤ºä¾‹ï¼Œä¸æ„æˆåŒ»ç–—è¯Šæ–­æˆ–æ­£å¼å¥åº·å»ºè®®ã€‚
      æ•°æ®æŒ‰æœ¬è®¾å¤‡ç”Ÿæˆçš„åŒ¿åIDå­˜å…¥ Firebase Realtime Databaseã€‚
    </div>
    <h1>å¥³æ€§å¥åº·ç®¡ç†ç³»ç»Ÿï¼ˆFirebaseç¤ºä¾‹ï¼Œæ— ç™»å½•ï¼‰</h1>
    <p class="small-text">
      æµç¨‹ï¼šæ³¨å†Œä¸ªäººåŸºæœ¬ä¿¡æ¯ â†’ è¿›å…¥ç¬¬äºŒé¡µè®°å½• <b>ç”Ÿç†å‘¨æœŸ / èº«ä½“çŠ¶å†µ / æƒ…ç»ªä¸ç”Ÿæ´»æ–¹å¼</b> â†’ è‡ªåŠ¨ç”Ÿæˆç®€å•å¥åº·æé†’ä¸æƒ…ç»ªé¢„æµ‹æç¤ºã€‚
    </p>
  </div>

  <!-- ========== é¡µé¢ 1ï¼šæ³¨å†Œä¸ªäººåŸºæœ¬ä¿¡æ¯ ========== -->
  <div id="profile-view" class="card">
    <h2>ç¬¬ 1 æ­¥ï¼šæ³¨å†Œä¸ªäººåŸºæœ¬ä¿¡æ¯</h2>
    <div id="profile-msg"></div>

    <div class="row">
      <div class="col-2">
        <div class="form-group">
          <label>å§“å / æ˜µç§°</label>
          <input type="text" id="profile-name" placeholder="ä¾‹å¦‚ï¼šå°A" />
        </div>
        <div class="form-group">
          <label>å¹´é¾„</label>
          <input type="number" id="profile-age" min="10" max="60" />
        </div>
        <div class="form-group">
          <label>èº«é«˜ï¼ˆcmï¼‰</label>
          <input type="number" id="profile-height" min="120" max="200" />
        </div>
        <div class="form-group">
          <label>å½“å‰ä½“é‡ï¼ˆkgï¼‰</label>
          <input type="number" id="profile-weight" min="30" max="120" step="0.1" />
        </div>
      </div>

      <div class="col-1">
        <div class="form-group">
          <label>å¹³å‡æœˆç»å‘¨æœŸé•¿åº¦ï¼ˆå¤©ï¼‰<span class="badge">ä¾‹å¦‚ï¼š28</span></label>
          <input type="number" id="profile-cycle-length" min="20" max="40" />
        </div>
        <div class="form-group">
          <label>å¹³å‡ç»æœŸæŒç»­å¤©æ•°ï¼ˆå¤©ï¼‰</label>
          <input type="number" id="profile-period-length" min="2" max="10" />
        </div>
        <div class="form-group">
          <label>æœ€è¿‘ä¸€æ¬¡æœˆç»å¼€å§‹æ—¥æœŸ</label>
          <input type="date" id="profile-last-period" />
        </div>
        <div class="form-group">
          <label>ç»æœŸé€šå¸¸æµé‡</label>
          <select id="profile-usual-flow">
            <option value="">è¯·é€‰æ‹©</option>
            <option value="è½»">è½»</option>
            <option value="ä¸­ç­‰">ä¸­ç­‰</option>
            <option value="è¾ƒå¤š">è¾ƒå¤š</option>
          </select>
        </div>
      </div>
    </div>

    <button class="btn-primary" onclick="saveProfileAndNext()">ä¿å­˜å¹¶è¿›å…¥å¥åº·è®°å½•é¡µé¢</button>
    <p class="small-text" style="margin-top:6px;">
      æç¤ºï¼šä¿¡æ¯å°†ä»¥æœ¬è®¾å¤‡çš„åŒ¿åIDå­˜å‚¨åœ¨ Firebase Realtime Database çš„
      <code>users/{anonymousUid}/profile</code> ä¸‹ã€‚
    </p>
  </div>

  <!-- ========== é¡µé¢ 2ï¼šæ¯æ—¥è®°å½•ä¸åˆ†æ ========== -->
  <div id="tracker-view" class="hidden">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
        <div>
          <h2 id="tracker-title">ç¬¬ 2 æ­¥ï¼šæ¯æ—¥å¥åº·è®°å½•ä¸åˆ†æ</h2>
          <p class="small-text">
            è¯·æ ¹æ®å½“å¤©æƒ…å†µå¡«å†™ï¼Œç³»ç»Ÿä¼šç»“åˆä½ çš„å‘¨æœŸå‚æ•°ç»™å‡ºç®€å•çš„
            <b>ç»æœŸ / æ’åµ / æƒ…ç»ªæ³¢åŠ¨</b> æç¤ºã€‚
          </p>
        </div>
        <button class="btn-secondary btn-small" onclick="backToProfile()">â† ä¿®æ”¹åŸºæœ¬ä¿¡æ¯</button>
      </div>
    </div>

    <div class="row">
      <!-- å·¦ä¾§ï¼šè¡¨å• -->
      <div class="col-2">
        <div class="card">
          <h3>ğŸ“… å½“æ—¥è®°å½•</h3>
          <div id="record-msg"></div>

          <div class="form-group">
            <label>è®°å½•æ—¥æœŸ</label>
            <input type="date" id="record-date" />
          </div>

          <div class="section-title">1. ç”Ÿç†å‘¨æœŸæ‰©å±•æ•°æ®</div>
          <div class="form-group">
            <label>ä»Šå¤©æ˜¯å¦åœ¨ç»æœŸï¼Ÿ</label>
            <select id="cycle-on-period">
              <option value="å¦">å¦</option>
              <option value="æ˜¯">æ˜¯</option>
            </select>
          </div>
          <div class="form-group">
            <label>ä»Šæ—¥æœˆç»é‡</label>
            <select id="cycle-flow">
              <option value="">è¯·é€‰æ‹©</option>
              <option value="è½»">è½»</option>
              <option value="ä¸­ç­‰">ä¸­ç­‰</option>
              <option value="è¾ƒå¤š">è¾ƒå¤š</option>
            </select>
          </div>
          <div class="form-group">
            <label>ç»è¡€é¢œè‰²</label>
            <select id="cycle-color">
              <option value="">è¯·é€‰æ‹©</option>
              <option value="é²œçº¢">é²œçº¢</option>
              <option value="æš—çº¢">æš—çº¢</option>
              <option value="å’–å•¡è‰²">å’–å•¡è‰²</option>
              <option value="åç²‰">åç²‰</option>
            </select>
          </div>
          <div class="form-group">
            <label>ç»æœŸç—‡çŠ¶ï¼ˆå¯å¤šé€‰ï¼‰</label>
            <div class="checkbox-group">
              <label><input type="checkbox" name="symptom" value="ç—›ç»">ç—›ç»</label>
              <label><input type="checkbox" name="symptom" value="å¤´ç—›">å¤´ç—›</label>
              <label><input type="checkbox" name="symptom" value="æ¶å¿ƒ">æ¶å¿ƒ</label>
              <label><input type="checkbox" name="symptom" value="ç–²åŠ³">ç–²åŠ³</label>
              <label><input type="checkbox" name="symptom" value="æƒ…ç»ªæ³¢åŠ¨">æƒ…ç»ªæ³¢åŠ¨</label>
            </div>
          </div>

          <div class="section-title">2. èº«ä½“çŠ¶å†µç›¸å…³</div>
          <div class="form-group">
            <label>ä»Šæ—¥ä½“é‡ï¼ˆkgï¼‰</label>
            <input type="number" id="body-weight" step="0.1" />
          </div>
          <div class="form-group">
            <label>ä»Šæ—¥æ­¥æ•°</label>
            <input type="number" id="body-steps" />
          </div>
          <div class="form-group">
            <label>æœ‰æ°§ / è¿åŠ¨æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
            <input type="number" id="body-exercise-min" />
          </div>
          <div class="form-group">
            <label>ç¡çœ å¼€å§‹æ—¶é—´</label>
            <input type="time" id="sleep-start" />
          </div>
          <div class="form-group">
            <label>ç¡çœ ç»“æŸæ—¶é—´</label>
            <input type="time" id="sleep-end" />
          </div>
          <div class="form-group">
            <label>ä»Šæ—¥é¥®æ°´é‡ï¼ˆæ¯«å‡ï¼‰</label>
            <input type="number" id="body-water" />
          </div>
          <div class="form-group">
            <label>é¥®é£Ÿç±»å‹</label>
            <select id="body-diet">
              <option value="">è¯·é€‰æ‹©</option>
              <option value="æ¸…æ·¡">æ¸…æ·¡</option>
              <option value="åå’¸">åå’¸</option>
              <option value="åç”œ">åç”œ</option>
              <option value="é«˜è›‹ç™½">é«˜è›‹ç™½</option>
              <option value="é«˜è„‚ / æ²¹ç‚¸">é«˜è„‚ / æ²¹ç‚¸</option>
            </select>
          </div>

          <div class="section-title">3. æƒ…ç»ª & è§¦å‘å› ç´ </div>
          <div class="form-group">
            <label>ä»Šæ—¥æ•´ä½“æƒ…ç»ªè¯„åˆ†ï¼ˆ1=å¾ˆå·® ~ 5=å¾ˆå¥½ï¼‰</label>
            <input type="number" id="emotion-score" min="1" max="5" value="3" />
          </div>
          <div class="form-group">
            <label>ä»Šæ—¥å‹åŠ›æŒ‡æ•°ï¼ˆ1=å¾ˆè½» ~ 5=å¾ˆå¤§ï¼‰</label>
            <input type="number" id="stress-score" min="1" max="5" value="3" />
          </div>
          <div class="form-group">
            <label>æƒ…ç»ªè§¦å‘å› ç´ ï¼ˆå¯å¤šé€‰ï¼‰</label>
            <div class="checkbox-group">
              <label><input type="checkbox" name="trigger" value="å·¥ä½œå‹åŠ›">å·¥ä½œå‹åŠ›</label>
              <label><input type="checkbox" name="trigger" value="å­¦ä¸šå‹åŠ›">å­¦ä¸šå‹åŠ›</label>
              <label><input type="checkbox" name="trigger" value="å…³ç³»é—®é¢˜">å…³ç³»é—®é¢˜</label>
              <label><input type="checkbox" name="trigger" value="ç”Ÿç†ä¸é€‚">ç”Ÿç†ä¸é€‚</label>
              <label><input type="checkbox" name="trigger" value="ç¡çœ ä¸è¶³">ç¡çœ ä¸è¶³</label>
              <label><input type="checkbox" name="trigger" value="è·å°”è’™æ³¢åŠ¨">è·å°”è’™æ³¢åŠ¨</label>
            </div>
          </div>

          <div class="section-title">4. æƒ…ç»ªé¢„æµ‹ç›¸å…³ä¿¡æ¯</div>
          <div class="form-group">
            <label>è‚¤å†µ</label>
            <select id="skin-status">
              <option value="">è¯·é€‰æ‹©</option>
              <option value="æ­£å¸¸">æ­£å¸¸</option>
              <option value="é•¿ç—˜">é•¿ç—˜</option>
              <option value="å‡ºæ²¹">å‡ºæ²¹</option>
              <option value="å¹²ç‡¥">å¹²ç‡¥</option>
            </select>
          </div>
          <div class="form-group">
            <label>æ¿€ç´ ç›¸å…³æ„Ÿå—ï¼ˆå¯å¤šé€‰ï¼‰</label>
            <div class="checkbox-group">
              <label><input type="checkbox" name="hormone" value="æ˜“æ€’">æ˜“æ€’</label>
              <label><input type="checkbox" name="hormone" value="æƒ…ç»ªåŒ–">æƒ…ç»ªåŒ–</label>
              <label><input type="checkbox" name="hormone" value="é£Ÿæ¬²å¢åŠ ">é£Ÿæ¬²å¢åŠ </label>
              <label><input type="checkbox" name="hormone" value="é£Ÿæ¬²ä¸‹é™">é£Ÿæ¬²ä¸‹é™</label>
            </div>
          </div>

          <div class="section-title">5. ç”Ÿæ´»æ–¹å¼ / ä¹ æƒ¯</div>
          <div class="form-group">
            <label>è¿åŠ¨ç±»å‹ï¼ˆç‘œä¼½ / å¥èº« / è·‘æ­¥ç­‰ï¼‰</label>
            <input type="text" id="lifestyle-exercise-type" placeholder="ä¾‹å¦‚ï¼šç‘œä¼½30åˆ†é’Ÿ + æ•£æ­¥" />
          </div>
          <div class="form-group">
            <label>æ€§ç”Ÿæ´»è®°å½•ï¼ˆå¯é€‰ï¼Œç®€å•æ–‡å­—ï¼‰</label>
            <textarea id="lifestyle-sex" placeholder="ä¾‹å¦‚ï¼šå®‰å…¨æœŸ / æ˜¯å¦é¿å­•ï¼ˆè¯·è°¨æ…è¾“å…¥éšç§ä¿¡æ¯ï¼‰"></textarea>
          </div>

          <button class="btn-primary" onclick="saveDailyRecord()">ä¿å­˜ä»Šæ—¥è®°å½•</button>
        </div>
      </div>

      <!-- å³ä¾§ï¼šæé†’ & ç®€è¦åˆ†æ -->
      <div class="col-1">
        <div class="card">
          <h3>ğŸ”” å¥åº·æé†’ä¸å»ºè®®</h3>
          <div id="reminder-area">
            <p class="small-text">æ ¹æ®ä½ çš„åŸºæœ¬å‘¨æœŸä¿¡æ¯ä¸æœ€è¿‘è®°å½•ï¼Œç³»ç»Ÿå°†åœ¨è¿™é‡Œç»™å‡ºï¼šç»æœŸé¢„æµ‹ã€æ’åµæœŸæç¤ºã€æƒ…ç»ªæ³¢åŠ¨æé†’ç­‰ã€‚</p>
          </div>
        </div>

        <div class="card">
          <h3>ğŸ§  æƒ…ç»ªè¶‹åŠ¿ & ç®€å•é¢„æµ‹</h3>
          <div id="emotion-prediction" class="small-text">
            æš‚æ— è¶³å¤Ÿæ•°æ®ï¼Œè¯·å…ˆè®°å½•å‡ å¤©çš„æƒ…ç»ªã€‚
          </div>
        </div>

        <div class="card">
          <h3>ğŸ—‚ æœ€è¿‘è®°å½•ä¸€è§ˆï¼ˆç®€ç‰ˆï¼‰</h3>
          <div id="recent-records" class="small-text">æ­£åœ¨åŠ è½½...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ========== 1. åˆå§‹åŒ– Firebase ==========
  const firebaseConfig = {
    apiKey: "AIzaSyA8m1mFT8lwW553kB3pJmVv8ViMEBYSrDM",
    authDomain: "my-women-s-health-management.firebaseapp.com",
    databaseURL: "https://my-women-s-health-management-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "my-women-s-health-management",
    storageBucket: "my-women-s-health-management.firebasestorage.app",
    messagingSenderId: "281305293774",
    appId: "1:281305293774:web:7f3345d120d1b2d5c8819f",
    measurementId: "G-E2T3SZ6CX9"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ä½¿ç”¨æœ¬åœ°ç”Ÿæˆçš„åŒ¿åUIDï¼Œä»£æ›¿ç™»å½•
  let currentUid = null;
  let userProfile = null;

  function initAnonymousUid() {
    const key = 'mh_local_uid';
    let uid = localStorage.getItem(key);
    if (!uid) {
      uid = 'u_' + Date.now() + '_' + Math.random().toString(36).slice(2, 10);
      localStorage.setItem(key, uid);
    }
    currentUid = uid;
  }

  function showMessage(id, text, type) {
    const el = document.getElementById(id);
    if (!text) { el.innerHTML = ''; return; }
    const cls = type === 'success' ? 'alert alert-success' :
                type === 'error'   ? 'alert alert-error'   :
                                     'alert alert-info';
    el.className = cls;
    el.textContent = text;
  }

  function todayStr() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  window.addEventListener('DOMContentLoaded', () => {
    initAnonymousUid();
    document.getElementById('record-date').value = todayStr();
    loadProfile();
  });

  // ========== 2. ä¸ªäººä¿¡æ¯ï¼šä¿å­˜ & åŠ è½½ & é¡µé¢åˆ‡æ¢ ==========
  function saveProfileAndNext() {
    if (!currentUid) {
      showMessage('profile-msg', 'æœ¬åœ°åŒ¿åIDæœªç”Ÿæˆï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚', 'error');
      return;
    }
    const uid = currentUid;
    const profile = {
      name: document.getElementById('profile-name').value.trim(),
      age: Number(document.getElementById('profile-age').value),
      height: Number(document.getElementById('profile-height').value),
      weight: Number(document.getElementById('profile-weight').value),
      cycleLength: Number(document.getElementById('profile-cycle-length').value),
      periodLength: Number(document.getElementById('profile-period-length').value),
      lastPeriodStart: document.getElementById('profile-last-period').value,
      usualFlow: document.getElementById('profile-usual-flow').value,
      updatedAt: Date.now()
    };

    if (!profile.name || !profile.age || !profile.cycleLength || !profile.lastPeriodStart) {
      showMessage('profile-msg', 'è¯·è‡³å°‘å¡«å†™å§“åã€å¹´é¾„ã€å¹³å‡å‘¨æœŸé•¿åº¦å’Œæœ€è¿‘ä¸€æ¬¡æœˆç»å¼€å§‹æ—¥æœŸã€‚', 'error');
      return;
    }

    db.ref('users/' + uid + '/profile').set(profile)
      .then(() => {
        showMessage('profile-msg', 'ä¸ªäººä¿¡æ¯å·²ä¿å­˜ã€‚', 'success');
        userProfile = profile;
        enterTrackerView();
      })
      .catch(err => showMessage('profile-msg', 'ä¿å­˜å¤±è´¥ï¼š' + err.message, 'error'));
  }

  function loadProfile() {
    if (!currentUid) return;
    const uid = currentUid;
    db.ref('users/' + uid + '/profile').once('value', snap => {
      const data = snap.val();
      if (data) {
        userProfile = data;
        document.getElementById('profile-name').value = data.name || '';
        document.getElementById('profile-age').value = data.age || '';
        document.getElementById('profile-height').value = data.height || '';
        document.getElementById('profile-weight').value = data.weight || '';
        document.getElementById('profile-cycle-length').value = data.cycleLength || '';
        document.getElementById('profile-period-length').value = data.periodLength || '';
        document.getElementById('profile-last-period').value = data.lastPeriodStart || '';
        document.getElementById('profile-usual-flow').value = data.usualFlow || '';

        // å¦‚æœå·²æœ‰èµ„æ–™ï¼Œé»˜è®¤ç›´æ¥è¿›å…¥è®°å½•é¡µé¢
        enterTrackerView();
      }
    });
  }

  function enterTrackerView() {
    document.getElementById('profile-view').classList.add('hidden');
    document.getElementById('tracker-view').classList.remove('hidden');
    if (userProfile && userProfile.name) {
      document.getElementById('tracker-title').textContent =
        `ç¬¬ 2 æ­¥ï¼š${userProfile.name} çš„æ¯æ—¥å¥åº·è®°å½•ä¸åˆ†æ`;
    }
    refreshReminders();
    loadRecentRecordsAndEmotion();
  }

  function backToProfile() {
    document.getElementById('tracker-view').classList.add('hidden');
    document.getElementById('profile-view').classList.remove('hidden');
  }

  // ========== 3. ä¿å­˜æ¯æ—¥è®°å½• ==========
  function getCheckedValues(name) {
    const nodes = document.querySelectorAll('input[name="'+name+'"]:checked');
    return Array.from(nodes).map(n => n.value);
  }

  function calcSleepHours(startStr, endStr) {
    if (!startStr || !endStr) return null;
    const [sh, sm] = startStr.split(':').map(Number);
    const [eh, em] = endStr.split(':').map(Number);
    let start = sh + sm/60;
    let end = eh + em/60;
    if (end < start) end += 24;
    return +(end - start).toFixed(2);
  }

  function saveDailyRecord() {
    if (!currentUid) {
      showMessage('record-msg', 'æœ¬åœ°åŒ¿åIDæœªç”Ÿæˆï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚', 'error');
      return;
    }
    const uid = currentUid;
    const date = document.getElementById('record-date').value || todayStr();

    const sleepHours = calcSleepHours(
      document.getElementById('sleep-start').value,
      document.getElementById('sleep-end').value
    );

    const record = {
      date,
      onPeriod: document.getElementById('cycle-on-period').value,
      flow: document.getElementById('cycle-flow').value,
      bloodColor: document.getElementById('cycle-color').value,
      symptoms: getCheckedValues('symptom'),
      bodyWeight: Number(document.getElementById('body-weight').value) || null,
      steps: Number(document.getElementById('body-steps').value) || null,
      exerciseMin: Number(document.getElementById('body-exercise-min').value) || null,
      sleepStart: document.getElementById('sleep-start').value,
      sleepEnd: document.getElementById('sleep-end').value,
      sleepHours: sleepHours,
      waterMl: Number(document.getElementById('body-water').value) || null,
      dietType: document.getElementById('body-diet').value,
      emotionScore: Number(document.getElementById('emotion-score').value) || null,
      stressScore: Number(document.getElementById('stress-score').value) || null,
      triggers: getCheckedValues('trigger'),
      skinStatus: document.getElementById('skin-status').value,
      hormoneFeelings: getCheckedValues('hormone'),
      exerciseType: document.getElementById('lifestyle-exercise-type').value.trim(),
      sexNote: document.getElementById('lifestyle-sex').value.trim(),
      timestamp: Date.now()
    };

    db.ref('users/' + uid + '/records/' + date).set(record)
      .then(() => {
        showMessage('record-msg', 'ä»Šæ—¥è®°å½•å·²ä¿å­˜ã€‚', 'success');
        refreshReminders();
        loadRecentRecordsAndEmotion();
      })
      .catch(err => showMessage('record-msg', 'ä¿å­˜å¤±è´¥ï¼š' + err.message, 'error'));
  }

  // ========== 4. å¥åº·æé†’ï¼ˆç»æœŸ / æ’åµ / å¼‚å¸¸å‘¨æœŸï¼‰ ==========
  function refreshReminders() {
    const box = document.getElementById('reminder-area');
    if (!userProfile || !userProfile.lastPeriodStart || !userProfile.cycleLength) {
      box.innerHTML = '<p class="small-text">è¯·å…ˆå®Œå–„åŸºæœ¬å‘¨æœŸä¿¡æ¯ï¼Œç³»ç»Ÿæ‰èƒ½ç»™å‡ºç»æœŸä¸æ’åµæœŸæé†’ã€‚</p>';
      return;
    }
    const cycleLen = Number(userProfile.cycleLength);
    const lastStart = new Date(userProfile.lastPeriodStart);
    const today = new Date();
    const msPerDay = 24*60*60*1000;
    const nextStart = new Date(lastStart.getTime() + cycleLen*msPerDay);
    const daysToNext = Math.round((nextStart - today)/msPerDay);

    const ovulation = new Date(nextStart.getTime() - 14*msPerDay);
    const daysToOvulation = Math.round((ovulation - today)/msPerDay);

    let html = '';

    if (daysToNext <= 3 && daysToNext >= -1) {
      html += `<div class="reminder-item reminder-strong">
        é¢„è®¡ ${daysToNext === 0 ? 'ä»Šå¤©' : (daysToNext + ' å¤©å')} å¼€å§‹ç”Ÿç†æœŸï¼Œè¯·æå‰å‡†å¤‡ç»æœŸç”¨å“ï¼Œæ³¨æ„ä¿æš–ä¸ä¼‘æ¯ã€‚
      </div>`;
    } else if (daysToNext > 3) {
      html += `<div class="reminder-item">é¢„è®¡çº¦ ${daysToNext} å¤©åå¼€å§‹ä¸‹ä¸€æ¬¡ç”Ÿç†æœŸã€‚</div>`;
    } else if (daysToNext < -1) {
      html += `<div class="reminder-item">æœ¬æ¬¡æœˆç»å·²è¶…è¿‡é¢„è®¡æ—¶é—´ï¼Œå¦‚æŒç»­æ¨è¿Ÿå»ºè®®é€‚å½“å…³æ³¨èº«ä½“çŠ¶æ€ã€‚</div>`;
    }

    if (daysToOvulation >= -2 && daysToOvulation <= 2) {
      html += `<div class="reminder-item reminder-strong">
        å½“å‰è¿›å…¥æ’åµé™„è¿‘æ˜“å­•æœŸã€‚å¦‚ä¸å¤‡å­•ï¼Œè¯·æ³¨æ„é¿å­•æªæ–½ï¼›å¦‚æœ‰å¤‡å­•è®¡åˆ’ï¼Œå¯ä»¥é€‚å½“å®‰æ’ã€‚
      </div>`;
    } else if (daysToOvulation > 2 && daysToOvulation <= 7) {
      html += `<div class="reminder-item">å¤§çº¦ ${daysToOvulation} å¤©åè¿›å…¥æ’åµæœŸæ˜“å­•çª—å£ã€‚</div>`;
    }

    if (cycleLen < 21 || cycleLen > 35) {
      html += `<div class="reminder-item reminder-strong">
        å½“å‰è®¾ç½®çš„å¹³å‡å‘¨æœŸä¸º ${cycleLen} å¤©ï¼Œåç¦»å¸¸è§èŒƒå›´ï¼ˆ21~35å¤©ï¼‰ã€‚å¦‚é•¿æœŸå¦‚æ­¤ï¼Œå»ºè®®ä¸ä¸“ä¸šåŒ»ç”Ÿè®¨è®ºã€‚
      </div>`;
    }

    if (!html) {
      html = '<p class="small-text">æš‚æ— ç‰¹åˆ«æé†’ã€‚è¯·ç»§ç»­ç¨³å®šè®°å½•ï¼Œç³»ç»Ÿä¼šé€æ¸ç”Ÿæˆæ›´å‡†ç¡®çš„æç¤ºã€‚</p>';
    }

    box.innerHTML = html;
  }

  // ========== 5. æœ€è¿‘è®°å½• & æƒ…ç»ªç®€å•é¢„æµ‹ ==========
  function loadRecentRecordsAndEmotion() {
    if (!currentUid) return;
    const uid = currentUid;
    const ref = db.ref('users/' + uid + '/records');

    ref.orderByChild('timestamp').limitToLast(30).once('value', snap => {
      const recordsDiv = document.getElementById('recent-records');
      const predDiv = document.getElementById('emotion-prediction');

      if (!snap.exists()) {
        recordsDiv.innerHTML = 'æš‚æ— è®°å½•ã€‚';
        predDiv.innerHTML = 'æš‚æ— è¶³å¤Ÿæ•°æ®ï¼Œè¯·å…ˆè¿ç»­è®°å½•å‡ å¤©çš„æƒ…ç»ªã€‚';
        return;
      }

      const list = [];
      snap.forEach(child => list.push(child.val()));
      list.sort((a,b) => (a.date > b.date ? 1 : -1));

      let html = '<table><thead><tr><th>æ—¥æœŸ</th><th>æƒ…ç»ª</th><th>å‹åŠ›</th><th>ç¡çœ h</th></tr></thead><tbody>';
      const last10 = list.slice(-10);
      last10.forEach(r => {
        html += `<tr>
          <td>${r.date}</td>
          <td>${r.emotionScore ?? '-'}</td>
          <td>${r.stressScore ?? '-'}</td>
          <td>${r.sleepHours ?? '-'}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      recordsDiv.innerHTML = html;

      const last7 = list.slice(-7);
      const emoArr = last7.map(r => Number(r.emotionScore || 0)).filter(v => v > 0);
      const stressArr = last7.map(r => Number(r.stressScore || 0)).filter(v => v > 0);
      const sleepArr = last7.map(r => Number(r.sleepHours || 0)).filter(v => v > 0);

      if (emoArr.length < 3) {
        predDiv.innerHTML = 'æœ€è¿‘æƒ…ç»ªè®°å½•ä¸è¶³ 3 æ¡ï¼Œéš¾ä»¥åˆ¤æ–­è¶‹åŠ¿ã€‚è¯·ç»§ç»­è®°å½•å‡ å¤©ã€‚';
        return;
      }

      const avg = arr => arr.reduce((s,v)=>s+v,0)/(arr.length || 1);
      const emoAvg = avg(emoArr);
      const stressAvg = stressArr.length ? avg(stressArr) : 3;
      const sleepAvg = sleepArr.length ? avg(sleepArr) : 7;

      let level = 'ä¸­ç­‰';
      let reason = `æœ€è¿‘ ${emoArr.length} å¤©çš„æƒ…ç»ªå¹³å‡åˆ†çº¦ä¸º ${emoAvg.toFixed(2)}ï¼Œå‹åŠ›å¹³å‡ä¸º ${stressAvg.toFixed(2)}ï¼Œç¡çœ çº¦ ${sleepAvg.toFixed(1)} å°æ—¶ã€‚`;

      if (emoAvg >= 4 && stressAvg <= 3 && sleepAvg >= 7) {
        level = 'åé«˜';
        reason += ' æ•´ä½“çŠ¶æ€è¾ƒå¥½ï¼Œæ˜å¤©å‡ºç°ç§¯ææƒ…ç»ªçš„å¯èƒ½æ€§è¾ƒå¤§ã€‚';
      } else if (emoAvg <= 2.5 || stressAvg >= 4 || sleepAvg < 6) {
        level = 'åä½';
        reason += ' æƒ…ç»ªæˆ–å‹åŠ›æœ‰ä¸€å®šè´Ÿæ‹…ï¼Œå»ºè®®é€‚å½“æ”¾æ¾ã€ä¿è¯ç¡çœ ï¼Œå¯å°è¯•å†¥æƒ³ / è½»è¿åŠ¨ã€‚';
      }

      predDiv.innerHTML = `
        <div>æ ¹æ®æœ€è¿‘å‡ å¤©æ•°æ®ï¼Œ<b>æ˜æ—¥æƒ…ç»ªæ°´å¹³é¢„æµ‹ï¼š${level}</b></div>
        <div style="margin-top:4px;">${reason}</div>
        <div class="small-text" style="margin-top:4px;">è¯¥é¢„æµ‹ä»…åŸºäºç®€å•ç»Ÿè®¡è§„åˆ™ï¼Œä¸æ„æˆå¿ƒç†æˆ–åŒ»ç–—å»ºè®®ã€‚</div>
      `;
    });
  }
</script>
</body>
</html>
