<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>女性健康管理系统（Firebase 版，无登录，多步表单）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase compat 版本：App + Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
  <!-- Chart.js 用于可视化图表 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
    }
    body {
      margin: 0;
      background: #f5f6fa;
      color: #333;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }
    h1, h2, h3 {
      margin-top: 0;
    }
    .card {
      background: #fff;
      border-radius: 14px;
      padding: 18px 18px 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
      margin-bottom: 16px;
    }
    .tagline {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #dfe4ff;
      color: #3b4cca;
      font-size: 11px;
      margin-left: 6px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
    }
    .col-2 { flex: 2; min-width: 260px; }
    .col-1 { flex: 1; min-width: 260px; }

    .form-group {
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 13px;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    input[type="checkbox"] {
      width: auto;
      margin-right: 4px;
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
      font-size: 12px;
    }
    .checkbox-group label {
      margin-bottom: 0;
    }
    button {
      border-radius: 999px;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      font-size: 13px;
    }
    .btn-primary {
      background: #4b7bec;
      color: #fff;
    }
    .btn-secondary {
      background: #f1f2f6;
      color: #333;
    }
    .btn-small {
      padding: 4px 10px;
      font-size: 12px;
    }
    .hidden {
      display: none;
    }
    .alert {
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .alert-info { background: #e9f5ff; color: #1e90ff; }
    .alert-success { background: #e7f9ed; color: #20bf6b; }
    .alert-error { background: #ffe9ec; color: #eb3b5a; }
    .small-text { font-size: 11px; color: #777; }

    .section-title {
      font-weight: 600;
      margin: 10px 0 4px;
      font-size: 14px;
    }
    .reminder-item {
      font-size: 12px;
      margin-bottom: 4px;
    }
    .reminder-strong {
      color: #eb3b5a;
      font-weight: 600;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 4px;
    }
    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #f1f2f6;
    }

    .step-indicator {
      font-size: 12px;
      color: #555;
      margin-bottom: 8px;
    }
    .step-indicator b {
      color: #4b7bec;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- 顶部说明 -->
  <div class="card">
    <div class="tagline">
      ⚠ 本系统仅用于学习与研究示例，不构成医疗诊断或正式健康建议。
      数据按本设备生成的匿名ID存入 Firebase Realtime Database。
    </div>
    <h1>女性健康管理系统（Firebase 示例，无登录，多步记录）</h1>
    <p class="small-text">
      流程：注册个人基本信息 → 多步记录 <b>生理周期 / 身体状况 / 情绪 / 生活方式</b> → 保存后生成女性生理健康建议 → 右侧可视化图表与趋势分析。
    </p>
  </div>

  <!-- ========== 页面 1：注册个人基本信息 ========== -->
  <div id="profile-view" class="card">
    <h2>第 1 步：注册个人基本信息</h2>
    <div id="profile-msg"></div>

    <div class="row">
      <div class="col-2">
        <div class="form-group">
          <label>姓名 / 昵称</label>
          <input type="text" id="profile-name" placeholder="例如：小A" />
        </div>
        <div class="form-group">
          <label>年龄</label>
          <input type="number" id="profile-age" min="10" max="60" />
        </div>
        <div class="form-group">
          <label>身高（cm）</label>
          <input type="number" id="profile-height" min="120" max="200" />
        </div>
        <div class="form-group">
          <label>当前体重（kg）</label>
          <input type="number" id="profile-weight" min="30" max="120" step="0.1" />
        </div>
      </div>

      <div class="col-1">
        <div class="form-group">
          <label>平均月经周期长度（天）<span class="badge">常见范围：21–35</span></label>
          <input type="number" id="profile-cycle-length" min="15" max="60" />
        </div>
        <div class="form-group">
          <label>平均经期持续天数（天）</label>
          <input type="number" id="profile-period-length" min="2" max="10" />
        </div>
        <div class="form-group">
          <label>最近一次月经开始日期</label>
          <input type="date" id="profile-last-period" />
        </div>
        <div class="form-group">
          <label>经期通常流量</label>
          <select id="profile-usual-flow">
            <option value="">请选择</option>
            <option value="轻">轻</option>
            <option value="中等">中等</option>
            <option value="较多">较多</option>
          </select>
        </div>
      </div>
    </div>

    <button class="btn-primary" onclick="saveProfileAndNext()">保存并进入健康记录页面</button>
    <p class="small-text" style="margin-top:6px;">
      信息将以本设备匿名ID存储在 <code>users/{anonymousUid}/profile</code> 下。
    </p>
  </div>

  <!-- ========== 页面 2：多步每日记录 + 建议 ========== -->
  <div id="tracker-view" class="hidden">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
        <div>
          <h2 id="tracker-title">第 2 步：每日健康记录与分析</h2>
          <div class="step-indicator">
            当前步骤：<b id="step-text">1 / 5</b>（生理周期 → 身体状况 → 情绪 → 情绪+生活方式 → 健康建议）
          </div>
        </div>
        <button class="btn-secondary btn-small" onclick="backToProfile()">← 修改基本信息</button>
      </div>
    </div>

    <div class="row">
      <!-- 左侧：多步表单 -->
      <div class="col-2">
        <div class="card">
          <h3>📅 当日记录</h3>
          <div id="record-msg"></div>

          <div class="form-group">
            <label>记录日期</label>
            <input type="date" id="record-date" />
          </div>

          <!-- Step 1：生理周期扩展数据 -->
          <div class="step-page" id="step-1">
            <div class="section-title">1. 生理周期扩展数据</div>
            <div class="form-group">
              <label>今天是否在经期？</label>
              <select id="cycle-on-period">
                <option value="否">否</option>
                <option value="是">是</option>
              </select>
            </div>
            <div class="form-group">
              <label>今日月经量</label>
              <select id="cycle-flow">
                <option value="">请选择</option>
                <option value="轻">轻</option>
                <option value="中等">中等</option>
                <option value="较多">较多</option>
              </select>
            </div>
            <div class="form-group">
              <label>经血颜色</label>
              <select id="cycle-color">
                <option value="">请选择</option>
                <option value="鲜红">鲜红</option>
                <option value="暗红">暗红</option>
                <option value="咖啡色">咖啡色</option>
                <option value="偏粉">偏粉</option>
              </select>
            </div>
            <div class="form-group">
              <label>经期症状（可多选）</label>
              <div class="checkbox-group">
                <label><input type="checkbox" name="symptom" value="痛经">痛经</label>
                <label><input type="checkbox" name="symptom" value="头痛">头痛</label>
                <label><input type="checkbox" name="symptom" value="恶心">恶心</label>
                <label><input type="checkbox" name="symptom" value="疲劳">疲劳</label>
                <label><input type="checkbox" name="symptom" value="情绪波动">情绪波动</label>
              </div>
            </div>
            <button class="btn-primary" type="button" onclick="nextStep()">下一页：身体状况 →</button>
          </div>

          <!-- Step 2：身体状况相关 -->
          <div class="step-page hidden" id="step-2">
            <div class="section-title">2. 身体状况相关</div>
            <div class="form-group">
              <label>今日体重（kg）</label>
              <input type="number" id="body-weight" step="0.1" />
            </div>
            <div class="form-group">
              <label>今日步数</label>
              <input type="number" id="body-steps" />
            </div>
            <div class="form-group">
              <label>有氧 / 运动时间（分钟）</label>
              <input type="number" id="body-exercise-min" />
            </div>
            <div class="form-group">
              <label>昨晚睡眠时长（小时）</label>
              <input type="number" id="sleep-hours" step="0.1" />
            </div>
            <div class="form-group">
              <label>今日饮水量（毫升）</label>
              <input type="number" id="body-water" />
            </div>
            <div class="form-group">
              <label>饮食类型</label>
              <select id="body-diet">
                <option value="">请选择</option>
                <option value="清淡">清淡</option>
                <option value="偏咸">偏咸</option>
                <option value="偏甜">偏甜</option>
                <option value="高蛋白">高蛋白</option>
                <option value="高脂 / 油炸">高脂 / 油炸</option>
              </select>
            </div>
            <button class="btn-secondary" type="button" onclick="prevStep()">← 上一页</button>
            <button class="btn-primary" type="button" onclick="nextStep()">下一页：情绪 →</button>
          </div>

          <!-- Step 3：情绪 & 触发因素 -->
          <div class="step-page hidden" id="step-3">
            <div class="section-title">3. 情绪 & 触发因素</div>
            <div class="form-group">
              <label>今日整体情绪评分（1=很差 ~ 5=很好）</label>
              <input type="number" id="emotion-score" min="1" max="5" value="3" />
            </div>
            <div class="form-group">
              <label>今日压力指数（1=很轻 ~ 5=很大）</label>
              <input type="number" id="stress-score" min="1" max="5" value="3" />
            </div>
            <div class="form-group">
              <label>情绪触发因素（可多选）</label>
              <div class="checkbox-group">
                <label><input type="checkbox" name="trigger" value="工作压力">工作压力</label>
                <label><input type="checkbox" name="trigger" value="学业压力">学业压力</label>
                <label><input type="checkbox" name="trigger" value="关系问题">关系问题</label>
                <label><input type="checkbox" name="trigger" value="生理不适">生理不适</label>
                <label><input type="checkbox" name="trigger" value="睡眠不足">睡眠不足</label>
                <label><input type="checkbox" name="trigger" value="荷尔蒙波动">荷尔蒙波动</label>
              </div>
            </div>
            <button class="btn-secondary" type="button" onclick="prevStep()">← 上一页</button>
            <button class="btn-primary" type="button" onclick="nextStep()">下一页：情绪预测 & 生活方式 →</button>
          </div>

          <!-- Step 4：情绪预测相关 + 生活方式 / 习惯（同一页） -->
          <div class="step-page hidden" id="step-4">
            <div class="section-title">4. 情绪预测相关信息</div>
            <div class="form-group">
              <label>肤况</label>
              <select id="skin-status">
                <option value="">请选择</option>
                <option value="正常">正常</option>
                <option value="长痘">长痘</option>
                <option value="出油">出油</option>
                <option value="干燥">干燥</option>
              </select>
            </div>
            <div class="form-group">
              <label>激素相关感受（可多选）</label>
              <div class="checkbox-group">
                <label><input type="checkbox" name="hormone" value="易怒">易怒</label>
                <label><input type="checkbox" name="hormone" value="情绪化">情绪化</label>
                <label><input type="checkbox" name="hormone" value="食欲增加">食欲增加</label>
                <label><input type="checkbox" name="hormone" value="食欲下降">食欲下降</label>
              </div>
            </div>

            <div class="section-title">5. 生活方式 / 习惯</div>
            <div class="form-group">
              <label>运动类型（瑜伽 / 健身 / 跑步等）</label>
              <input type="text" id="lifestyle-exercise-type" placeholder="例如：瑜伽30分钟 + 散步" />
            </div>
            <div class="form-group">
              <label>性生活记录（可选，简单文字）</label>
              <textarea id="lifestyle-sex" placeholder="例如：安全期 / 是否避孕（请谨慎输入隐私信息）"></textarea>
            </div>

            <button class="btn-secondary" type="button" onclick="prevStep()">← 上一页</button>
            <button class="btn-primary" type="button" onclick="saveDailyRecord(true)">保存并生成今日健康建议 →</button>
          </div>

          <!-- Step 5：保存后显示建议 -->
          <div class="step-page hidden" id="step-5">
            <div class="section-title">今日女性生理健康建议</div>
            <div id="advice-content" class="small-text">
              （保存记录后，这里会显示结合经期、身体状况与情绪的建议。）
            </div>
            <button class="btn-primary" type="button" onclick="goBackToFirstStep()">← 返回重新查看或继续记录</button>
          </div>
        </div>
      </div>

      <!-- 右侧：提醒 & 分析 & 可视化 -->
      <div class="col-1">
        <div class="card">
          <h3>🔔 健康提醒与周期建议</h3>
          <div id="reminder-area">
            <p class="small-text">根据你的基本周期信息与最近记录，系统将在这里给出经期预测、排卵期提醒等（仅在平均周期 21–35 天时启用）。</p>
          </div>
        </div>

        <div class="card">
          <h3>📊 情绪 / 压力 / 睡眠趋势图</h3>
          <canvas id="historyChart" height="150"></canvas>
          <div id="chart-summary" class="small-text" style="margin-top:6px;">
            暂无足够数据，请先记录几天。
          </div>
        </div>

        <div class="card">
          <h3>🧠 情绪趋势 & 简单预测</h3>
          <div id="emotion-prediction" class="small-text">
            暂无足够数据，请先记录几天的情绪。
          </div>
        </div>

        <div class="card">
          <h3>🗂 最近记录一览（简版）</h3>
          <div id="recent-records" class="small-text">正在加载...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ========== 1. 初始化 Firebase ==========
  const firebaseConfig = {
    apiKey: "AIzaSyA8m1mFT8lwW553kB3pJmVv8ViMEBYSrDM",
    authDomain: "my-women-s-health-management.firebaseapp.com",
    databaseURL: "https://my-women-s-health-management-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "my-women-s-health-management",
    storageBucket: "my-women-s-health-management.firebasestorage.app",
    messagingSenderId: "281305293774",
    appId: "1:281305293774:web:7f3345d120d1b2d5c8819f",
    measurementId: "G-E2T3SZ6CX9"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // 本地匿名UID
  let currentUid = null;
  let userProfile = null;
  let currentStep = 1;
  let lastSavedRecord = null;
  let historyChart = null;

  function initAnonymousUid() {
    const key = 'mh_local_uid';
    let uid = localStorage.getItem(key);
    if (!uid) {
      uid = 'u_' + Date.now() + '_' + Math.random().toString(36).slice(2, 10);
      localStorage.setItem(key, uid);
    }
    currentUid = uid;
  }

  function showMessage(id, text, type) {
    const el = document.getElementById(id);
    if (!text) { el.innerHTML = ''; return; }
    const cls = type === 'success' ? 'alert alert-success' :
                type === 'error'   ? 'alert alert-error'   :
                                     'alert alert-info';
    el.className = cls;
    el.textContent = text;
  }

  function todayStr() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  window.addEventListener('DOMContentLoaded', () => {
    initAnonymousUid();
    document.getElementById('record-date').value = todayStr();
    loadProfile();
    updateStepUI();
  });

  // ========== 2. 多步表单切换 ==========
  function updateStepUI() {
    for (let i = 1; i <= 5; i++) {
      const page = document.getElementById('step-' + i);
      if (!page) continue;
      if (i === currentStep) page.classList.remove('hidden');
      else page.classList.add('hidden');
    }
    document.getElementById('step-text').textContent = `${currentStep} / 5`;
  }
  function nextStep() {
    if (currentStep < 5) {
      currentStep += 1;
      updateStepUI();
    }
  }
  function prevStep() {
    if (currentStep > 1) {
      currentStep -= 1;
      updateStepUI();
    }
  }
  function goBackToFirstStep() {
    currentStep = 1;
    updateStepUI();
  }

  // ========== 3. 个人信息：保存 & 加载 & 页面切换 ==========
  function saveProfileAndNext() {
    if (!currentUid) {
      showMessage('profile-msg', '本地匿名ID未生成，请刷新页面重试。', 'error');
      return;
    }
    const uid = currentUid;
    const profile = {
      name: document.getElementById('profile-name').value.trim(),
      age: Number(document.getElementById('profile-age').value),
      height: Number(document.getElementById('profile-height').value),
      weight: Number(document.getElementById('profile-weight').value),
      cycleLength: Number(document.getElementById('profile-cycle-length').value),
      periodLength: Number(document.getElementById('profile-period-length').value),
      lastPeriodStart: document.getElementById('profile-last-period').value,
      usualFlow: document.getElementById('profile-usual-flow').value,
      updatedAt: Date.now()
    };

    if (!profile.name || !profile.age || !profile.cycleLength || !profile.lastPeriodStart) {
      showMessage('profile-msg', '请至少填写姓名、年龄、平均周期长度和最近一次月经开始日期。', 'error');
      return;
    }

    db.ref('users/' + uid + '/profile').set(profile)
      .then(() => {
        showMessage('profile-msg', '个人信息已保存。', 'success');
        userProfile = profile;
        enterTrackerView();
      })
      .catch(err => showMessage('profile-msg', '保存失败：' + err.message, 'error'));
  }

  function loadProfile() {
    if (!currentUid) return;
    const uid = currentUid;
    db.ref('users/' + uid + '/profile').once('value', snap => {
      const data = snap.val();
      if (data) {
        userProfile = data;
        document.getElementById('profile-name').value = data.name || '';
        document.getElementById('profile-age').value = data.age || '';
        document.getElementById('profile-height').value = data.height || '';
        document.getElementById('profile-weight').value = data.weight || '';
        document.getElementById('profile-cycle-length').value = data.cycleLength || '';
        document.getElementById('profile-period-length').value = data.periodLength || '';
        document.getElementById('profile-last-period').value = data.lastPeriodStart || '';
        document.getElementById('profile-usual-flow').value = data.usualFlow || '';

        enterTrackerView();
      }
    });
  }

  function enterTrackerView() {
    document.getElementById('profile-view').classList.add('hidden');
    document.getElementById('tracker-view').classList.remove('hidden');
    if (userProfile && userProfile.name) {
      document.getElementById('tracker-title').textContent =
        `第 2 步：${userProfile.name} 的每日健康记录与分析`;
    }
    currentStep = 1;
    updateStepUI();
    refreshReminders();
    loadRecentRecordsAndEmotion();
  }

  function backToProfile() {
    document.getElementById('tracker-view').classList.add('hidden');
    document.getElementById('profile-view').classList.remove('hidden');
  }

  // ========== 4. 保存每日记录 ==========
  function getCheckedValues(name) {
    const nodes = document.querySelectorAll('input[name="'+name+'"]:checked');
    return Array.from(nodes).map(n => n.value);
  }

  function buildRecordFromInputs() {
    const date = document.getElementById('record-date').value || todayStr();

    return {
      date,
      onPeriod: document.getElementById('cycle-on-period').value,
      flow: document.getElementById('cycle-flow').value,
      bloodColor: document.getElementById('cycle-color').value,
      symptoms: getCheckedValues('symptom'),
      bodyWeight: Number(document.getElementById('body-weight').value) || null,
      steps: Number(document.getElementById('body-steps').value) || null,
      exerciseMin: Number(document.getElementById('body-exercise-min').value) || null,
      sleepHours: Number(document.getElementById('sleep-hours').value) || null,
      waterMl: Number(document.getElementById('body-water').value) || null,
      dietType: document.getElementById('body-diet').value,
      emotionScore: Number(document.getElementById('emotion-score').value) || null,
      stressScore: Number(document.getElementById('stress-score').value) || null,
      triggers: getCheckedValues('trigger'),
      skinStatus: document.getElementById('skin-status').value,
      hormoneFeelings: getCheckedValues('hormone'),
      exerciseType: document.getElementById('lifestyle-exercise-type').value.trim(),
      sexNote: document.getElementById('lifestyle-sex').value.trim(),
      timestamp: Date.now()
    };
  }

  function saveDailyRecord(showAdvice) {
    if (!currentUid) {
      showMessage('record-msg', '本地匿名ID未生成，请刷新页面重试。', 'error');
      return;
    }
    const uid = currentUid;
    const record = buildRecordFromInputs();
    const date = record.date;

    db.ref('users/' + uid + '/records/' + date).set(record)
      .then(() => {
        showMessage('record-msg', '今日记录已保存。', 'success');
        lastSavedRecord = record;
        refreshReminders();
        loadRecentRecordsAndEmotion();
        if (showAdvice) {
          const adviceHtml = buildAdviceHTML(userProfile, record);
          document.getElementById('advice-content').innerHTML = adviceHtml;
          currentStep = 5;
          updateStepUI();
        }
      })
      .catch(err => showMessage('record-msg', '保存失败：' + err.message, 'error'));
  }

  // ========== 5. 健康提醒（经期 / 排卵 / 正常范围控制） ==========
  function refreshReminders() {
    const box = document.getElementById('reminder-area');
    if (!userProfile || !userProfile.lastPeriodStart || !userProfile.cycleLength) {
      box.innerHTML = '<p class="small-text">请先完善基本周期信息，系统才能给出经期与排卵期提醒。</p>';
      return;
    }
    const cycleLen = Number(userProfile.cycleLength);
    const lastStart = new Date(userProfile.lastPeriodStart);
    const today = new Date();
    const msPerDay = 24*60*60*1000;

    // 如果不在常见范围 21–35 天，只给温和提示，不做预测
    if (cycleLen < 21 || cycleLen > 35) {
      box.innerHTML = `
        <div class="reminder-item reminder-strong">
          当前设置的平均周期为 ${cycleLen} 天，超出常见范围（21–35 天），系统暂不提供经期与排卵期预测。
        </div>
        <div class="reminder-item">
          如果周期长期不规则，建议记录一段时间后咨询专业医生。
        </div>
      `;
      return;
    }

    const nextStart = new Date(lastStart.getTime() + cycleLen*msPerDay);
    const daysToNext = Math.round((nextStart - today)/msPerDay);
    const ovulation = new Date(nextStart.getTime() - 14*msPerDay);
    const daysToOvulation = Math.round((ovulation - today)/msPerDay);

    let html = '';

    // 经期预测提醒（仅在合理范围内）
    if (daysToNext <= 3 && daysToNext >= -3) {
      html += `<div class="reminder-item reminder-strong">
        预计 ${daysToNext === 0 ? '今天' : (daysToNext + ' 天后')} 开始生理期，请提前准备经期用品，注意保暖与休息。
      </div>`;
    } else if (daysToNext > 3 && daysToNext <= cycleLen + 5) {
      html += `<div class="reminder-item">预计约 ${daysToNext} 天后开始下一次生理期。</div>`;
    } else if (daysToNext < -3) {
      html += `<div class="reminder-item">
        本次月经已超过预计时间，如持续明显推迟，可结合自身情况考虑是否需要进一步检查。
      </div>`;
    }

    // 排卵期提醒 / 易孕窗口
    if (daysToOvulation >= -2 && daysToOvulation <= 2) {
      html += `<div class="reminder-item reminder-strong">
        当前处于排卵期附近易孕窗口。如不备孕，请注意有效避孕；如有备孕计划，可以适当安排。
      </div>`;
    } else if (daysToOvulation > 2 && daysToOvulation <= 7) {
      html += `<div class="reminder-item">大约 ${daysToOvulation} 天后进入排卵期易孕窗口。</div>`;
    }

    if (!html) {
      html = '<p class="small-text">暂无特别提醒。请继续稳定记录，系统会逐渐生成更准确的提示。</p>';
    }

    box.innerHTML = html;
  }

  // ========== 6. 最近记录 & 情绪预测 & 可视化 ==========
  function loadRecentRecordsAndEmotion() {
    if (!currentUid) return;
    const uid = currentUid;
    const ref = db.ref('users/' + uid + '/records');

    ref.orderByChild('timestamp').limitToLast(60).once('value', snap => {
      const recordsDiv = document.getElementById('recent-records');
      const predDiv = document.getElementById('emotion-prediction');
      const chartSummary = document.getElementById('chart-summary');

      if (!snap.exists()) {
        recordsDiv.innerHTML = '暂无记录。';
        predDiv.innerHTML = '暂无足够数据，请先连续记录几天的情绪。';
        chartSummary.textContent = '暂无数据可绘图。';
        if (historyChart) {
          historyChart.destroy();
          historyChart = null;
        }
        return;
      }

      const list = [];
      snap.forEach(child => list.push(child.val()));
      list.sort((a,b) => (a.date > b.date ? 1 : -1));

      // 简表
      let html = '<table><thead><tr><th>日期</th><th>情绪</th><th>压力</th><th>睡眠h</th></tr></thead><tbody>';
      const last10 = list.slice(-10);
      last10.forEach(r => {
        html += `<tr>
          <td>${r.date}</td>
          <td>${r.emotionScore ?? '-'}</td>
          <td>${r.stressScore ?? '-'}</td>
          <td>${r.sleepHours ?? '-'}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      recordsDiv.innerHTML = html;

      // 情绪 / 压力 / 睡眠趋势图
      updateHistoryChart(list);

      // 情绪预测 + 文本总结
      const last7 = list.slice(-7);
      const emoArr = last7.map(r => Number(r.emotionScore || 0)).filter(v => v > 0);
      const stressArr = last7.map(r => Number(r.stressScore || 0)).filter(v => v > 0);
      const sleepArr = last7.map(r => Number(r.sleepHours || 0)).filter(v => v > 0);

      if (emoArr.length < 3) {
        predDiv.innerHTML = '最近情绪记录不足 3 条，难以判断趋势。请继续记录几天。';
        chartSummary.textContent = '请至少连续记录 3 天以上，以便观察趋势。';
        return;
      }

      const avg = arr => arr.reduce((s,v)=>s+v,0)/(arr.length || 1);
      const emoAvg = avg(emoArr);
      const stressAvg = stressArr.length ? avg(stressArr) : 3;
      const sleepAvg = sleepArr.length ? avg(sleepArr) : 7;

      let level = '中等';
      let reason = `最近 ${emoArr.length} 天的情绪平均分约为 ${emoAvg.toFixed(2)}，压力平均为 ${stressAvg.toFixed(2)}，睡眠约 ${sleepAvg.toFixed(1)} 小时。`;

      if (emoAvg >= 4 && stressAvg <= 3 && sleepAvg >= 7) {
        level = '偏高';
        reason += ' 整体状态较好，明天出现积极情绪的可能性较大。';
      } else if (emoAvg <= 2.5 || stressAvg >= 4 || sleepAvg < 6) {
        level = '偏低';
        reason += ' 情绪或压力有一定负担，建议适当放松、保证睡眠，可尝试冥想 / 轻运动。';
      }

      predDiv.innerHTML = `
        <div>根据最近几天数据，<b>明日情绪水平预测：${level}</b></div>
        <div style="margin-top:4px;">${reason}</div>
        <div class="small-text" style="margin-top:4px;">该预测仅基于简单统计规则，不构成心理或医疗建议。</div>
      `;

      // 图表分析总结
      chartSummary.innerHTML = `
        最近 ${list.length} 次记录中，情绪与压力整体呈现 <b>${level}</b> 水平。
        可重点关注压力较高或睡眠偏少的日期，结合图表进行自我调节与规划。
      `;
    });
  }

  function updateHistoryChart(list) {
    const ctx = document.getElementById('historyChart').getContext('2d');
    const labels = list.map(r => r.date);
    const emoData = list.map(r => r.emotionScore ?? null);
    const stressData = list.map(r => r.stressScore ?? null);
    const sleepData = list.map(r => r.sleepHours ?? null);

    if (historyChart) {
      historyChart.destroy();
    }

    historyChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: '情绪评分',
            data: emoData,
            borderColor: '#4b7bec',
            backgroundColor: 'rgba(75,123,236,0.1)',
            tension: 0.2,
            yAxisID: 'y'
          },
          {
            label: '压力指数',
            data: stressData,
            borderColor: '#eb3b5a',
            backgroundColor: 'rgba(235,59,90,0.1)',
            tension: 0.2,
            yAxisID: 'y'
          },
          {
            label: '睡眠时长（小时）',
            data: sleepData,
            borderColor: '#20bf6b',
            backgroundColor: 'rgba(32,191,107,0.1)',
            borderDash: [4,2],
            tension: 0.2,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        stacked: false,
        scales: {
          y: {
            type: 'linear',
            position: 'left',
            suggestedMin: 0,
            suggestedMax: 5,
            title: { display: true, text: '情绪 / 压力（1~5）' }
          },
          y1: {
            type: 'linear',
            position: 'right',
            suggestedMin: 0,
            suggestedMax: 10,
            grid: { drawOnChartArea: false },
            title: { display: true, text: '睡眠时长（小时）' }
          }
        }
      }
    });
  }

  // ========== 7. 生成“女性生理健康建议” ==========
// 结合当日记录 + 周期信息，输出一段较完整的建议文本
  function buildAdviceHTML(profile, record) {
    const parts = [];

    // 基本情况说明
    parts.push(`<p>基于你今天的记录（日期：<b>${record.date}</b>）、周期参数和近期状态，以下建议仅供自我观察与参考。</p>`);

    // 经期相关建议
    if (record.onPeriod === '是') {
      parts.push('<p><b>经期护理：</b>今天处于经期，请注意保暖，避免腹部受凉和过度劳累。可适当进行轻柔拉伸或散步，有助于缓解不适。</p>');
      if (record.flow === '较多') {
        parts.push('<p>你记录的经血量偏多，如连续多日量大、伴有明显乏力或头晕，建议留意是否有贫血风险，并根据需要咨询医生。</p>');
      }
      if (record.symptoms && record.symptoms.includes('痛经')) {
        parts.push('<p>出现痛经时，可尝试热敷下腹部、保持情绪稳定，避免过度咖啡因和辛辣饮食。如疼痛持续严重且影响生活，可考虑专业就医评估。</p>');
      }
    } else {
      parts.push('<p><b>非经期观察：</b>目前不在经期，可关注白带、情绪、睡眠与能量水平的变化，为下一个周期作准备。</p>');
    }

    // 情绪与压力
    if (record.emotionScore != null) {
      if (record.emotionScore <= 2) {
        parts.push('<p><b>情绪关怀：</b>今天整体情绪评分偏低，可以给自己多一点休息与缓冲时间。建议安排一些让自己放松的活动，如散步、听舒缓音乐或进行简单冥想。</p>');
      } else if (record.emotionScore >= 4) {
        parts.push('<p><b>情绪表现良好：</b>今天情绪状态较好，可以适当安排学习 / 工作重点任务，也别忘了保留一点“留白时间”照顾自己。</p>');
      }
    }
    if (record.stressScore != null && record.stressScore >= 4) {
      parts.push('<p>你的压力指数偏高，建议尝试将任务拆分成小步骤，合理安排节奏；必要时可以与信任的人（朋友、家人、老师等）分享压力感受。</p>');
    }

    // 睡眠
    if (record.sleepHours != null) {
      if (record.sleepHours < 6) {
        parts.push('<p><b>睡眠提醒：</b>昨晚睡眠时长偏短（少于 6 小时），长期睡眠不足会加重情绪波动和经期不适。建议尽可能保证 7 小时左右的高质量睡眠。</p>');
      } else if (record.sleepHours >= 7 && record.sleepHours <= 9) {
        parts.push('<p>你的睡眠时长在相对理想范围（约 7–9 小时），可以继续保持良好的作息节律。</p>');
      }
    }

    // 生活方式
    if (record.dietType === '高脂 / 油炸' || record.dietType === '偏甜') {
      parts.push('<p><b>饮食建议：</b>今天的饮食偏油或偏甜，建议在经期及排卵附近适度控制此类食物，多选择清淡、高纤维、高蛋白的组合，有助于血糖稳定和情绪平稳。</p>');
    } else if (record.dietType === '清淡' || record.dietType === '高蛋白') {
      parts.push('<p>今天的饮食记录相对健康，有利于体重管理和激素平衡，可以继续保持。</p>');
    }

    if (record.waterMl != null && record.waterMl < 1200) {
      parts.push('<p><b>补水提示：</b>今日饮水量略少，建议适当增加温水或淡茶摄入，有助于缓解疲劳与头痛等不适。</p>');
    }

    if (record.exerciseMin != null) {
      if (record.exerciseMin >= 30) {
        parts.push('<p>你今天完成了较充足的运动（≥30 分钟），有助于提升心情和睡眠质量。但经期时仍要避免过度剧烈的训练。</p>');
      } else if (record.exerciseMin > 0 && record.exerciseMin < 20) {
        parts.push('<p>今天的运动时间偏少，可以考虑安排 10–20 分钟的轻运动，例如拉伸、散步或瑜伽，以促进血液循环和放松身心。</p>');
      }
    }

    // 情绪触发因素 & 激素相关感受
    if (record.triggers && record.triggers.length > 0) {
      parts.push(`<p><b>情绪触发因素：</b>你记录的可能触发因素包括：${record.triggers.join('、')}。可以尝试为其中一项设计一个“小应对策略”，例如：为工作压力设定可控的待办清单，为睡眠不足调整固定的上床时间。</p>`);
    }
    if (record.hormoneFeelings && record.hormoneFeelings.length > 0) {
      parts.push(`<p>你提到的激素相关感受（如：${record.hormoneFeelings.join('、')}）在经前和经期阶段较为常见。若这些情况持续影响学习、工作或人际关系，建议适时寻求专业意见（妇科或心理咨询）。</p>`);
    }

    // 周期整体观察提醒
    if (profile && profile.cycleLength) {
      const c = Number(profile.cycleLength);
      if (c >= 21 && c <= 35) {
        parts.push(`<p><b>周期整体提醒：</b>你的平均周期设置为约 ${c} 天，属于常见范围。建议坚持记录至少 3–6 个月，以便更准确地观察“实际周期 vs 预测周期”的差异，为后续就医或自我管理提供参考数据。</p>`);
      } else {
        parts.push(`<p><b>周期不规则提示：</b>你当前填写的平均周期约为 ${c} 天，略超出常见范围（21–35 天）。建议持续记录一段时间，如果长期明显不规律，可结合个人状况咨询医生。</p>`);
      }
    }

    parts.push('<p class="small-text">以上建议仅基于你填写的数据与一般女性生理健康常识，并不能替代专业医疗意见。如有持续不适或明显异常，请及时就医。</p>');
    return parts.join('');
  }
</script>
</body>
</html>
