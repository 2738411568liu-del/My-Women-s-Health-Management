<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å¥³æ€§å¥åº·å°åŠ©æ‰‹ Â· æ¢¦å¹»ç´«æ˜Ÿç©ºç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase compat ç‰ˆæœ¬ï¼šApp + Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
  <!-- Chart.js ç”¨äºå¯è§†åŒ–å›¾è¡¨ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", "Segoe UI", sans-serif;
    }
    :root {
      /* æ¢¦å¹»ç´« & æ˜Ÿå…‰é£ä¸»è‰² */
      --primary: #9b6bff;
      --primary-soft: #e9ddff;
      --primary-deep: #6c3bff;
      --accent-pink: #ff7ac7;
      --bg-gradient-start: #221638;
      --bg-gradient-mid: #362655;
      --bg-gradient-end: #f4ecff;
      --card-bg: #ffffff;
      --text-main: #2b2140;
      --text-soft: #9489b5;
      --border-soft: rgba(155, 107, 255, 0.18);
    }
    body {
      margin: 0;
      /* æ˜Ÿç©ºæ¸å˜èƒŒæ™¯ */
      background:
        radial-gradient(circle at 10% 0%, rgba(255,255,255,0.12), transparent 60%),
        radial-gradient(circle at 80% 0%, rgba(255,195,252,0.14), transparent 55%),
        linear-gradient(180deg, var(--bg-gradient-start), var(--bg-gradient-mid) 35%, var(--bg-gradient-end) 100%);
      color: var(--text-main);
      min-height: 100vh;
    }

    /* ç®€å•æ˜Ÿæ˜Ÿç‚¹ç¼€ */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(255,255,255,0.55) 0, transparent 2px),
        radial-gradient(circle at 30% 80%, rgba(255,255,255,0.35) 0, transparent 2px),
        radial-gradient(circle at 70% 30%, rgba(255,255,255,0.4) 0, transparent 2px),
        radial-gradient(circle at 85% 60%, rgba(255,255,255,0.2) 0, transparent 1.5px);
      opacity: 0.5;
      z-index: 0;
    }

    .app-shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px 14px 40px;
      position: relative;
      z-index: 1;
    }

    /* é¡¶éƒ¨å¯¼èˆªæ¡ */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      margin-bottom: 12px;
      border-radius: 999px;
      background: rgba(25, 16, 48, 0.88);
      box-shadow: 0 16px 30px rgba(5, 0, 40, 0.55);
      border: 1px solid rgba(190, 163, 255, 0.6);
      backdrop-filter: blur(16px);
      color: #f7f1ff;
    }
    .topbar-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .topbar-logo {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 20%, #fff7ff, #c9a7ff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 0 16px rgba(201, 167, 255, 0.9);
    }
    .topbar-title {
      font-size: 15px;
      font-weight: 600;
      color: #fef1ff;
    }
    .topbar-sub {
      font-size: 11px;
      color: #d3c8ff;
    }
    .topbar-right {
      font-size: 11px;
      color: #fbe2ff;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(155, 107, 255, 0.25);
      border: 1px solid rgba(226, 199, 255, 0.6);
    }

    .container {
      margin-top: 10px;
    }

    h1, h2, h3 {
      margin-top: 0;
    }

    .card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 18px 18px 16px;
      box-shadow: 0 18px 40px rgba(25, 9, 60, 0.25);
      margin-bottom: 16px;
      border: 1px solid var(--border-soft);
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: "";
      position: absolute;
      inset: -30%;
      background:
        radial-gradient(circle at 0% 0%, rgba(209, 187, 255, 0.45), transparent 60%),
        radial-gradient(circle at 100% 0%, rgba(255, 195, 252, 0.4), transparent 55%);
      opacity: 0.6;
      pointer-events: none;
    }
    .card > * {
      position: relative;
      z-index: 1;
    }

    .tagline {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .tag-pill {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(155, 107, 255, 0.12);
      color: var(--primary-deep);
      font-size: 11px;
    }

    h1 {
      font-size: 22px;
      color: var(--primary-deep);
    }
    h2 {
      font-size: 18px;
      color: var(--primary-deep);
    }
    h3 {
      font-size: 15px;
      color: var(--primary);
    }
    .small-text {
      font-size: 11px;
      color: var(--text-soft);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
    }
    .col-2 { flex: 2; min-width: 260px; }
    .col-1 { flex: 1.1; min-width: 260px; }

    .form-group {
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: #4c426b;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(180, 160, 255, 0.7);
      font-size: 13px;
      background: #fbf8ff;
      outline: none;
      transition: box-shadow 0.2s, border-color 0.2s, background 0.2s;
      color: var(--text-main);
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(155, 107, 255, 0.25);
      background: #ffffff;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    input[type="checkbox"] {
      width: auto;
      margin-right: 4px;
      accent-color: var(--primary);
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 10px;
      font-size: 12px;
    }
    .checkbox-group label {
      margin-bottom: 0;
      padding: 4px 7px;
      border-radius: 999px;
      background: #f4edff;
      border: 1px solid rgba(155, 107, 255, 0.35);
      color: #5a4c81;
    }

    button {
      border-radius: 999px;
      padding: 9px 16px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--accent-pink));
      color: #fff;
      box-shadow: 0 10px 24px rgba(66, 37, 136, 0.7);
    }
    .btn-primary:hover {
      filter: brightness(1.06);
    }
    .btn-secondary {
      background: #f5f0ff;
      color: var(--primary-deep);
      border: 1px solid rgba(155, 107, 255, 0.4);
      box-shadow: 0 4px 12px rgba(25, 9, 60, 0.25);
    }
    .btn-secondary:hover {
      background: #ece1ff;
    }
    .btn-small {
      padding: 5px 10px;
      font-size: 11px;
    }

    .hidden { display: none; }

    .alert {
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .alert-info {
      background: #f4edff;
      color: #654f9c;
      border: 1px solid rgba(155, 107, 255, 0.4);
    }
    .alert-success {
      background: #edfdf6;
      color: #20bf6b;
      border: 1px solid rgba(32,191,107,0.25);
    }
    .alert-error {
      background: #fff0f3;
      color: #eb3b5a;
      border: 1px solid rgba(235,59,90,0.3);
    }

    .section-title {
      font-weight: 600;
      margin: 10px 0 4px;
      font-size: 13px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .section-title::before {
      content: "";
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--primary);
      box-shadow: 0 0 10px rgba(155, 107, 255, 0.6);
    }

    .step-indicator {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .step-indicator b {
      color: var(--primary-deep);
    }
    .step-pill {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(155, 107, 255, 0.5);
      background: #f4edff;
      font-size: 11px;
      color: var(--primary-deep);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 4px;
      background: #fbf8ff;
      border-radius: 12px;
      overflow: hidden;
    }
    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid #e2d6ff;
    }
    th {
      background: #e9ddff;
      color: #5a4c81;
    }

    canvas {
      background: #fbf8ff;
      border-radius: 12px;
      padding: 4px;
    }

    @media (max-width: 768px) {
      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <!-- é¡¶éƒ¨å¯¼èˆªæ¡ -->
  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-logo">ğŸŒ™</div>
      <div>
        <div class="topbar-title">å¥³æ€§å¥åº·å°åŠ©æ‰‹ Â· æ¢¦å¹»ç´«</div>
        <div class="topbar-sub">ç”Ÿç†å‘¨æœŸ Â· æƒ…ç»ª Â· ç”Ÿæ´»æ–¹å¼ Â· æ˜Ÿå…‰ä¸‹çš„è‡ªæˆ‘ç…§é¡¾</div>
      </div>
    </div>
    <div class="topbar-right">æœ¬åœ°åŒ¿åè®°å½• Â· Firebase å­¦ä¹ ç¤ºä¾‹</div>
  </div>

  <div class="container">
    <!-- é¡¶éƒ¨è¯´æ˜ -->
    <div class="card">
      <div class="tagline">
        <span class="tag-pill">âš  éåŒ»ç–—äº§å“</span>
        <span>ä»…ç”¨äºè¯¾ç¨‹ / ç ”ç©¶ç¤ºä¾‹ï¼Œä¸ä½œä¸ºæ­£å¼è¯Šæ–­ä¸åŒ»ç–—å»ºè®®ã€‚</span>
      </div>
      <h1>ç”Ÿç†å‘¨æœŸä¸æƒ…ç»ªç®¡ç† Â· æ˜Ÿå…‰ç‰ˆ</h1>
      <p class="small-text">
        æµç¨‹ï¼šå¡«å†™<b>åŸºæœ¬èµ„æ–™</b> â†’ åˆ†æ­¥è®°å½•<b>ç”Ÿç†å‘¨æœŸ / èº«ä½“çŠ¶å†µ / æƒ…ç»ª / ç”Ÿæ´»æ–¹å¼</b> â†’ è‡ªåŠ¨ç”Ÿæˆ<b>å¥åº·å»ºè®®</b>ä¸<b>è¶‹åŠ¿å›¾è¡¨</b>ï¼Œ
        è‰²è°ƒå‚è€ƒç¾æŸšï¼Œä¸»è‰²ä¸ºæ¢¦å¹»ç´« & æ˜Ÿå…‰æ°›å›´ã€‚
      </p>
    </div>

    <!-- ========== é¡µé¢ 1ï¼šæ³¨å†Œä¸ªäººåŸºæœ¬ä¿¡æ¯ ========== -->
    <div id="profile-view" class="card">
      <h2>â‘  åŸºæœ¬èµ„æ–™</h2>
      <div id="profile-msg"></div>

      <div class="row">
        <div class="col-2">
          <div class="form-group">
            <label>æ˜µç§°</label>
            <input type="text" id="profile-name" placeholder="ä¾‹å¦‚ï¼šå°A / å°æœˆäº®" />
          </div>
          <div class="form-group">
            <label>å¹´é¾„</label>
            <input type="number" id="profile-age" min="10" max="60" />
          </div>
          <div class="form-group">
            <label>èº«é«˜ï¼ˆcmï¼‰</label>
            <input type="number" id="profile-height" min="120" max="200" />
          </div>
          <div class="form-group">
            <label>å½“å‰ä½“é‡ï¼ˆkgï¼‰</label>
            <input type="number" id="profile-weight" min="30" max="120" step="0.1" />
          </div>
        </div>

        <div class="col-1">
          <div class="form-group">
            <label>å¹³å‡æœˆç»å‘¨æœŸé•¿åº¦ï¼ˆå¤©ï¼‰<span class="small-text">ï¼ˆå¸¸è§ï¼š21â€“35ï¼‰</span></label>
            <input type="number" id="profile-cycle-length" min="15" max="60" />
          </div>
          <div class="form-group">
            <label>å¹³å‡ç»æœŸæŒç»­å¤©æ•°ï¼ˆå¤©ï¼‰</label>
            <input type="number" id="profile-period-length" min="2" max="10" />
          </div>
          <div class="form-group">
            <label>æœ€è¿‘ä¸€æ¬¡æœˆç»å¼€å§‹æ—¥æœŸ</label>
            <input type="date" id="profile-last-period" />
          </div>
          <div class="form-group">
            <label>ç»æœŸé€šå¸¸æµé‡</label>
            <select id="profile-usual-flow">
              <option value="">è¯·é€‰æ‹©</option>
              <option value="è½»">è½»</option>
              <option value="ä¸­ç­‰">ä¸­ç­‰</option>
              <option value="è¾ƒå¤š">è¾ƒå¤š</option>
            </select>
          </div>
        </div>
      </div>

      <button class="btn-primary" onclick="saveProfileAndNext()">ä¿å­˜å¹¶å¼€å§‹æ¯æ—¥è®°å½• â†’</button>
      <p class="small-text" style="margin-top:6px;">
        æ•°æ®ä¼šä»¥æœ¬è®¾å¤‡åŒ¿åIDå­˜å‚¨åœ¨ <code>users/{anonymousUid}/profile</code> ä¸‹ï¼›åˆ·æ–°æµè§ˆå™¨åä¾ç„¶å¯ä»¥ç»§ç»­ä½¿ç”¨æœ¬åœ°è´¦å·ã€‚
      </p>
    </div>

    <!-- ========== é¡µé¢ 2ï¼šå¤šæ­¥æ¯æ—¥è®°å½• + å»ºè®® ========== -->
    <div id="tracker-view" class="hidden">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
          <div>
            <h2 id="tracker-title">â‘¡ æ¯æ—¥è®°å½• Â· ä»Šå¤œæ˜Ÿå…‰ä¸‹çš„ä½ </h2>
            <div class="step-indicator">
              <span class="step-pill">å½“å‰æ­¥éª¤ï¼š<span id="step-text">1 / 5</span></span>
              <span>ç”Ÿç†å‘¨æœŸ â†’ èº«ä½“çŠ¶å†µ â†’ æƒ…ç»ª â†’ æƒ…ç»ª&ç”Ÿæ´»æ–¹å¼ â†’ å½“æ—¥å»ºè®®</span>
            </div>
          </div>
          <button class="btn-secondary btn-small" onclick="backToProfile()">â† è¿”å›ä¿®æ”¹åŸºæœ¬èµ„æ–™</button>
        </div>
      </div>

      <div class="row">
        <!-- å·¦ä¾§ï¼šå¤šæ­¥è¡¨å• -->
        <div class="col-2">
          <div class="card">
            <h3>ğŸ“… å½“æ—¥è®°å½•</h3>
            <p class="small-text" style="margin-bottom:8px;">åªéœ€è¦å‡ åˆ†é’Ÿï¼ŒæŠŠä»Šå¤©çš„èº«ä½“ä¸æƒ…ç»ªæ‚„æ‚„è®°ä¸‹æ¥ã€‚</p>
            <div id="record-msg"></div>

            <div class="form-group">
              <label>è®°å½•æ—¥æœŸ</label>
              <input type="date" id="record-date" />
            </div>

            <!-- Step 1ï¼šç”Ÿç†å‘¨æœŸæ‰©å±•æ•°æ® -->
            <div class="step-page" id="step-1">
              <div class="section-title">1. ç”Ÿç†å‘¨æœŸæ‰©å±•æ•°æ®</div>
              <p class="small-text">è¿™ä¸€é¡µä¸»è¦æ˜¯å…³äºâ€œä»Šå¤©çš„ç»æœŸæƒ…å†µâ€ï¼Œç®€å•é€‰æ‹©å³å¯ï½</p>
              <div class="form-group">
                <label>ä»Šå¤©æ˜¯å¦åœ¨ç»æœŸï¼Ÿ</label>
                <select id="cycle-on-period">
                  <option value="å¦">å¦</option>
                  <option value="æ˜¯">æ˜¯</option>
                </select>
              </div>
              <div class="form-group">
                <label>ä»Šæ—¥æœˆç»é‡</label>
                <select id="cycle-flow">
                  <option value="">è¯·é€‰æ‹©</option>
                  <option value="è½»">è½»</option>
                  <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                  <option value="è¾ƒå¤š">è¾ƒå¤š</option>
                </select>
              </div>
              <div class="form-group">
                <label>ç»è¡€é¢œè‰²</label>
                <select id="cycle-color">
                  <option value="">è¯·é€‰æ‹©</option>
                  <option value="é²œçº¢">é²œçº¢</option>
                  <option value="æš—çº¢">æš—çº¢</option>
                  <option value="å’–å•¡è‰²">å’–å•¡è‰²</option>
                  <option value="åç²‰">åç²‰</option>
                </select>
              </div>
              <div class="form-group">
                <label>ç»æœŸç—‡çŠ¶ï¼ˆå¯å¤šé€‰ï¼‰</label>
                <div class="checkbox-group">
                  <label><input type="checkbox" name="symptom" value="ç—›ç»">ç—›ç»</label>
                  <label><input type="checkbox" name="symptom" value="å¤´ç—›">å¤´ç—›</label>
                  <label><input type="checkbox" name="symptom" value="æ¶å¿ƒ">æ¶å¿ƒ</label>
                  <label><input type="checkbox" name="symptom" value="ç–²åŠ³">ç–²åŠ³</label>
                  <label><input type="checkbox" name="symptom" value="æƒ…ç»ªæ³¢åŠ¨">æƒ…ç»ªæ³¢åŠ¨</label>
                </div>
              </div>
              <button class="btn-primary" type="button" onclick="nextStep()">ä¸‹ä¸€æ­¥ï¼šèº«ä½“çŠ¶å†µ â†’</button>
            </div>

            <!-- Step 2ï¼šèº«ä½“çŠ¶å†µç›¸å…³ -->
            <div class="step-page hidden" id="step-2">
              <div class="section-title">2. èº«ä½“çŠ¶å†µç›¸å…³</div>
              <p class="small-text">çœ‹çœ‹èº«ä½“ä»Šå¤©å‘å‡ºçš„ä¿¡å·ï¼šä½“é‡ã€è¿åŠ¨ã€ç¡çœ å’Œå–æ°´æƒ…å†µã€‚</p>
              <div class="form-group">
                <label>ä»Šæ—¥ä½“é‡ï¼ˆkgï¼‰<span class="small-text">ï¼ˆå¯é€‰ï¼‰</span></label>
                <input type="number" id="body-weight" step="0.1" />
              </div>
              <div class="form-group">
                <label>ä»Šæ—¥æ­¥æ•°<span class="small-text">ï¼ˆå¯é€‰ï¼‰</span></label>
                <input type="number" id="body-steps" />
              </div>
              <div class="form-group">
                <label>æœ‰æ°§ / è¿åŠ¨æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰<span class="small-text">ï¼ˆå¯é€‰ï¼‰</span></label>
                <input type="number" id="body-exercise-min" />
              </div>
              <div class="form-group">
                <label>æ˜¨æ™šç¡çœ æ—¶é•¿ï¼ˆå°æ—¶ï¼‰</label>
                <input type="number" id="sleep-hours" step="0.1" />
              </div>
              <div class="form-group">
                <label>ä»Šæ—¥é¥®æ°´é‡ï¼ˆæ¯«å‡ï¼‰</label>
                <input type="number" id="body-water" />
              </div>
              <div class="form-group">
                <label>é¥®é£Ÿç±»å‹</label>
                <select id="body-diet">
                  <option value="">è¯·é€‰æ‹©</option>
                  <option value="æ¸…æ·¡">æ¸…æ·¡</option>
                  <option value="åå’¸">åå’¸</option>
                  <option value="åç”œ">åç”œ</option>
                  <option value="é«˜è›‹ç™½">é«˜è›‹ç™½</option>
                  <option value="é«˜è„‚ / æ²¹ç‚¸">é«˜è„‚ / æ²¹ç‚¸</option>
                </select>
              </div>
              <button class="btn-secondary" type="button" onclick="prevStep()">â† ä¸Šä¸€æ­¥</button>
              <button class="btn-primary" type="button" onclick="nextStep()">ä¸‹ä¸€æ­¥ï¼šæƒ…ç»ª â†’</button>
            </div>

            <!-- Step 3ï¼šæƒ…ç»ª & è§¦å‘å› ç´  -->
            <div class="step-page hidden" id="step-3">
              <div class="section-title">3. æƒ…ç»ª & è§¦å‘å› ç´ </div>
              <p class="small-text">æƒ…ç»ªæ²¡æœ‰å¥½åï¼Œä½ ç°åœ¨çš„æ„Ÿå—éƒ½å¾ˆé‡è¦ã€‚</p>
              <div class="form-group">
                <label>ä»Šæ—¥æ•´ä½“æƒ…ç»ªè¯„åˆ†ï¼ˆ1=å¾ˆå·® ~ 5=å¾ˆå¥½ï¼‰</label>
                <input type="number" id="emotion-score" min="1" max="5" value="3" />
              </div>
              <div class="form-group">
                <label>ä»Šæ—¥å‹åŠ›æŒ‡æ•°ï¼ˆ1=å¾ˆè½» ~ 5=å¾ˆå¤§ï¼‰</label>
                <input type="number" id="stress-score" min="1" max="5" value="3" />
              </div>
              <div class="form-group">
                <label>æƒ…ç»ªè§¦å‘å› ç´ ï¼ˆå¯å¤šé€‰ï¼‰</label>
                <div class="checkbox-group">
                  <label><input type="checkbox" name="trigger" value="å·¥ä½œå‹åŠ›">å·¥ä½œå‹åŠ›</label>
                  <label><input type="checkbox" name="trigger" value="å­¦ä¸šå‹åŠ›">å­¦ä¸šå‹åŠ›</label>
                  <label><input type="checkbox" name="trigger" value="å…³ç³»é—®é¢˜">å…³ç³»é—®é¢˜</label>
                  <label><input type="checkbox" name="trigger" value="ç”Ÿç†ä¸é€‚">ç”Ÿç†ä¸é€‚</label>
                  <label><input type="checkbox" name="trigger" value="ç¡çœ ä¸è¶³">ç¡çœ ä¸è¶³</label>
                  <label><input type="checkbox" name="trigger" value="è·å°”è’™æ³¢åŠ¨">è·å°”è’™æ³¢åŠ¨</label>
                </div>
              </div>
              <button class="btn-secondary" type="button" onclick="prevStep()">â† ä¸Šä¸€æ­¥</button>
              <button class="btn-primary" type="button" onclick="nextStep()">ä¸‹ä¸€æ­¥ï¼šæƒ…ç»ªé¢„æµ‹ & ç”Ÿæ´»æ–¹å¼ â†’</button>
            </div>

            <!-- Step 4ï¼šæƒ…ç»ªé¢„æµ‹ç›¸å…³ + ç”Ÿæ´»æ–¹å¼ / ä¹ æƒ¯ï¼ˆåŒä¸€é¡µï¼‰ -->
            <div class="step-page hidden" id="step-4">
              <div class="section-title">4. æƒ…ç»ªé¢„æµ‹ç›¸å…³ä¿¡æ¯</div>
              <div class="form-group">
                <label>è‚¤å†µ</label>
                <select id="skin-status">
                  <option value="">è¯·é€‰æ‹©</option>
                  <option value="æ­£å¸¸">æ­£å¸¸</option>
                  <option value="é•¿ç—˜">é•¿ç—˜</option>
                  <option value="å‡ºæ²¹">å‡ºæ²¹</option>
                  <option value="å¹²ç‡¥">å¹²ç‡¥</option>
                </select>
              </div>
              <div class="form-group">
                <label>æ¿€ç´ ç›¸å…³æ„Ÿå—ï¼ˆå¯å¤šé€‰ï¼‰</label>
                <div class="checkbox-group">
                  <label><input type="checkbox" name="hormone" value="æ˜“æ€’">æ˜“æ€’</label>
                  <label><input type="checkbox" name="hormone" value="æƒ…ç»ªåŒ–">æƒ…ç»ªåŒ–</label>
                  <label><input type="checkbox" name="hormone" value="é£Ÿæ¬²å¢åŠ ">é£Ÿæ¬²å¢åŠ </label>
                  <label><input type="checkbox" name="hormone" value="é£Ÿæ¬²ä¸‹é™">é£Ÿæ¬²ä¸‹é™</label>
                </div>
              </div>

              <div class="section-title">5. ç”Ÿæ´»æ–¹å¼ / ä¹ æƒ¯</div>
              <div class="form-group">
                <label>è¿åŠ¨ç±»å‹ï¼ˆç‘œä¼½ / å¥èº« / è·‘æ­¥ç­‰ï¼‰</label>
                <input type="text" id="lifestyle-exercise-type" placeholder="ä¾‹å¦‚ï¼šç‘œä¼½30åˆ†é’Ÿ + æ•£æ­¥" />
              </div>
              <div class="form-group">
                <label>æ€§ç”Ÿæ´»è®°å½•ï¼ˆå¯é€‰ï¼Œç®€å•æ–‡å­—ï¼‰</label>
                <textarea id="lifestyle-sex" placeholder="ä¾‹å¦‚ï¼šå®‰å…¨æœŸ / æ˜¯å¦é¿å­•ï¼ˆè¯·è°¨æ…è¾“å…¥éšç§ä¿¡æ¯ï¼‰"></textarea>
              </div>

              <button class="btn-secondary" type="button" onclick="prevStep()">â† ä¸Šä¸€æ­¥</button>
              <button class="btn-primary" type="button" onclick="saveDailyRecord(true)">ä¿å­˜å¹¶ç”Ÿæˆä»Šæ—¥å»ºè®® â†’</button>
            </div>

            <!-- Step 5ï¼šä¿å­˜åæ˜¾ç¤ºå»ºè®® -->
            <div class="step-page hidden" id="step-5">
              <div class="section-title">ä»Šæ—¥å¥³æ€§ç”Ÿç†å¥åº·å»ºè®®</div>
              <div id="advice-content" class="small-text">
                ï¼ˆä¿å­˜è®°å½•åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºç»“åˆç»æœŸã€èº«ä½“çŠ¶å†µä¸æƒ…ç»ªçš„æ–‡å­—å»ºè®®ã€‚ï¼‰
              </div>
              <button class="btn-primary" type="button" onclick="goBackToFirstStep()">â† è¿”å›ç»§ç»­è®°å½•</button>
            </div>
          </div>
        </div>

        <!-- å³ä¾§ï¼šæé†’ & åˆ†æ & å¯è§†åŒ– -->
        <div class="col-1">
          <div class="card">
            <h3>ğŸ”” å¥åº·æé†’ä¸å‘¨æœŸå»ºè®®</h3>
            <div id="reminder-area">
              <p class="small-text">
                æ ¹æ®ä½ çš„å‘¨æœŸå‚æ•°ä¸æœ€è¿‘è®°å½•ï¼Œç³»ç»Ÿåœ¨è¿™é‡Œç»™å‡º<b>ç»æœŸé¢„æµ‹ã€æ’åµæœŸæé†’</b>ç­‰æç¤ºã€‚
                ä»…åœ¨å¹³å‡å‘¨æœŸ 21â€“35 å¤©èŒƒå›´å†…å¯ç”¨é¢„æµ‹ã€‚
              </p>
            </div>
          </div>

          <div class="card">
            <h3>ğŸ“Š æƒ…ç»ª / å‹åŠ› / ç¡çœ è¶‹åŠ¿</h3>
            <canvas id="historyChart" height="150"></canvas>
            <div id="chart-summary" class="small-text" style="margin-top:6px;">
              æš‚æ— æ•°æ®ï¼Œè¯·å…ˆè¿ç»­è®°å½•å‡ å¤©ã€‚
            </div>
          </div>

          <div class="card">
            <h3>ğŸ§  æƒ…ç»ªè¶‹åŠ¿ & ç®€å•é¢„æµ‹</h3>
            <div id="emotion-prediction" class="small-text">
              æš‚æ— è¶³å¤Ÿæ•°æ®ï¼Œè¯·å…ˆè®°å½•å‡ å¤©çš„æƒ…ç»ªã€‚
            </div>
          </div>

          <div class="card">
            <h3>ğŸ—‚ æœ€è¿‘è®°å½•ä¸€è§ˆï¼ˆç®€ç‰ˆï¼‰</h3>
            <div id="recent-records" class="small-text">æ­£åœ¨åŠ è½½...</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ========== 1. åˆå§‹åŒ– Firebase ==========
  const firebaseConfig = {
    apiKey: "AIzaSyA8m1mFT8lwW553kB3pJmVv8ViMEBYSrDM",
    authDomain: "my-women-s-health-management.firebaseapp.com",
    databaseURL: "https://my-women-s-health-management-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "my-women-s-health-management",
    storageBucket: "my-women-s-health-management.firebasestorage.app",
    messagingSenderId: "281305293774",
    appId: "1:281305293774:web:7f3345d120d1b2d5c8819f",
    measurementId: "G-E2T3SZ6CX9"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentUid = null;
  let userProfile = null;
  let currentStep = 1;
  let lastSavedRecord = null;
  let historyChart = null;

  function initAnonymousUid() {
    const key = 'mh_local_uid';
    let uid = localStorage.getItem(key);
    if (!uid) {
      uid = 'u_' + Date.now() + '_' + Math.random().toString(36).slice(2, 10);
      localStorage.setItem(key, uid);
    }
    currentUid = uid;
  }

  function showMessage(id, text, type) {
    const el = document.getElementById(id);
    if (!text) { el.innerHTML = ''; return; }
    const cls = type === 'success' ? 'alert alert-success' :
                type === 'error'   ? 'alert alert-error'   :
                                     'alert alert-info';
    el.className = cls;
    el.textContent = text;
  }

  function todayStr() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  window.addEventListener('DOMContentLoaded', () => {
    initAnonymousUid();
    document.getElementById('record-date').value = todayStr();
    loadProfile();
    updateStepUI();
  });

  // ========== 2. å¤šæ­¥è¡¨å•åˆ‡æ¢ ==========
  function updateStepUI() {
    for (let i = 1; i <= 5; i++) {
      const page = document.getElementById('step-' + i);
      if (!page) continue;
      if (i === currentStep) page.classList.remove('hidden');
      else page.classList.add('hidden');
    }
    document.getElementById('step-text').textContent = `${currentStep} / 5`;
  }
  function nextStep() {
    if (currentStep < 5) {
      currentStep += 1;
      updateStepUI();
    }
  }
  function prevStep() {
    if (currentStep > 1) {
      currentStep -= 1;
      updateStepUI();
    }
  }
  function goBackToFirstStep() {
    currentStep = 1;
    updateStepUI();
  }

  // ========== 3. ä¸ªäººä¿¡æ¯ï¼šä¿å­˜ & åŠ è½½ & é¡µé¢åˆ‡æ¢ ==========
  function saveProfileAndNext() {
    if (!currentUid) {
      showMessage('profile-msg', 'æœ¬åœ°åŒ¿åIDæœªç”Ÿæˆï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚', 'error');
      return;
    }
    const uid = currentUid;
    const profile = {
      name: document.getElementById('profile-name').value.trim(),
      age: Number(document.getElementById('profile-age').value),
      height: Number(document.getElementById('profile-height').value),
      weight: Number(document.getElementById('profile-weight').value),
      cycleLength: Number(document.getElementById('profile-cycle-length').value),
      periodLength: Number(document.getElementById('profile-period-length').value),
      lastPeriodStart: document.getElementById('profile-last-period').value,
      usualFlow: document.getElementById('profile-usual-flow').value,
      updatedAt: Date.now()
    };

    if (!profile.name || !profile.age || !profile.cycleLength || !profile.lastPeriodStart) {
      showMessage('profile-msg', 'è¯·è‡³å°‘å¡«å†™æ˜µç§°ã€å¹´é¾„ã€å¹³å‡å‘¨æœŸé•¿åº¦å’Œæœ€è¿‘ä¸€æ¬¡æœˆç»å¼€å§‹æ—¥æœŸã€‚', 'error');
      return;
    }

    db.ref('users/' + uid + '/profile').set(profile)
      .then(() => {
        showMessage('profile-msg', 'åŸºæœ¬èµ„æ–™å·²ä¿å­˜ã€‚', 'success');
        userProfile = profile;
        enterTrackerView();
      })
      .catch(err => showMessage('profile-msg', 'ä¿å­˜å¤±è´¥ï¼š' + err.message, 'error'));
  }

  function loadProfile() {
    if (!currentUid) return;
    const uid = currentUid;
    db.ref('users/' + uid + '/profile').once('value', snap => {
      const data = snap.val();
      if (data) {
        userProfile = data;
        document.getElementById('profile-name').value = data.name || '';
        document.getElementById('profile-age').value = data.age || '';
        document.getElementById('profile-height').value = data.height || '';
        document.getElementById('profile-weight').value = data.weight || '';
        document.getElementById('profile-cycle-length').value = data.cycleLength || '';
        document.getElementById('profile-period-length').value = data.periodLength || '';
        document.getElementById('profile-last-period').value = data.lastPeriodStart || '';
        document.getElementById('profile-usual-flow').value = data.usualFlow || '';

        enterTrackerView();
      }
    });
  }

  function enterTrackerView() {
    document.getElementById('profile-view').classList.add('hidden');
    document.getElementById('tracker-view').classList.remove('hidden');
    if (userProfile && userProfile.name) {
      document.getElementById('tracker-title').textContent =
        `â‘¡ ${userProfile.name} çš„æ¯æ—¥è®°å½• Â· æ˜Ÿå…‰é™ªä¼´`;
    }
    currentStep = 1;
    updateStepUI();
    refreshReminders();
    loadRecentRecordsAndEmotion();
  }

  function backToProfile() {
    document.getElementById('tracker-view').classList.add('hidden');
    document.getElementById('profile-view').classList.remove('hidden');
  }

  // ========== 4. ä¿å­˜æ¯æ—¥è®°å½• ==========
  function getCheckedValues(name) {
    const nodes = document.querySelectorAll('input[name="'+name+'"]:checked');
    return Array.from(nodes).map(n => n.value);
  }

  function buildRecordFromInputs() {
    const date = document.getElementById('record-date').value || todayStr();

    return {
      date,
      onPeriod: document.getElementById('cycle-on-period').value,
      flow: document.getElementById('cycle-flow').value,
      bloodColor: document.getElementById('cycle-color').value,
      symptoms: getCheckedValues('symptom'),
      bodyWeight: Number(document.getElementById('body-weight').value) || null,
      steps: Number(document.getElementById('body-steps').value) || null,
      exerciseMin: Number(document.getElementById('body-exercise-min').value) || null,
      sleepHours: Number(document.getElementById('sleep-hours').value) || null,
      waterMl: Number(document.getElementById('body-water').value) || null,
      dietType: document.getElementById('body-diet').value,
      emotionScore: Number(document.getElementById('emotion-score').value) || null,
      stressScore: Number(document.getElementById('stress-score').value) || null,
      triggers: getCheckedValues('trigger'),
      skinStatus: document.getElementById('skin-status').value,
      hormoneFeelings: getCheckedValues('hormone'),
      exerciseType: document.getElementById('lifestyle-exercise-type').value.trim(),
      sexNote: document.getElementById('lifestyle-sex').value.trim(),
      timestamp: Date.now()
    };
  }

  function saveDailyRecord(showAdvice) {
    if (!currentUid) {
      showMessage('record-msg', 'æœ¬åœ°åŒ¿åIDæœªç”Ÿæˆï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚', 'error');
      return;
    }
    const uid = currentUid;
    const record = buildRecordFromInputs();
    const date = record.date;

    db.ref('users/' + uid + '/records/' + date).set(record)
      .then(() => {
        showMessage('record-msg', 'ä»Šæ—¥è®°å½•å·²ä¿å­˜ã€‚', 'success');
        lastSavedRecord = record;
        refreshReminders();
        loadRecentRecordsAndEmotion();
        if (showAdvice) {
          const adviceHtml = buildAdviceHTML(userProfile, record);
          document.getElementById('advice-content').innerHTML = adviceHtml;
          currentStep = 5;
          updateStepUI();
        }
      })
      .catch(err => showMessage('record-msg', 'ä¿å­˜å¤±è´¥ï¼š' + err.message, 'error'));
  }

  // ========== 5. å¥åº·æé†’ï¼ˆç»æœŸ / æ’åµ / æ­£å¸¸èŒƒå›´æ§åˆ¶ï¼‰ ==========
  function refreshReminders() {
    const box = document.getElementById('reminder-area');
    if (!userProfile || !userProfile.lastPeriodStart || !userProfile.cycleLength) {
      box.innerHTML = '<p class="small-text">è¯·å…ˆå®Œå–„åŸºæœ¬å‘¨æœŸä¿¡æ¯ï¼Œç³»ç»Ÿæ‰èƒ½ç»™å‡ºç»æœŸä¸æ’åµæœŸæé†’ã€‚</p>';
      return;
    }
    const cycleLen = Number(userProfile.cycleLength);
    const lastStart = new Date(userProfile.lastPeriodStart);
    const today = new Date();
    const msPerDay = 24*60*60*1000;

    if (cycleLen < 21 || cycleLen > 35) {
      box.innerHTML = `
        <div class="alert alert-info">
          å½“å‰å¹³å‡å‘¨æœŸä¸º ${cycleLen} å¤©ï¼Œè¶…å‡ºå¸¸è§èŒƒå›´ï¼ˆ21â€“35 å¤©ï¼‰ï¼Œç³»ç»Ÿæš‚ä¸æä¾›ç»æœŸä¸æ’åµæœŸé¢„æµ‹ã€‚
          å¦‚é•¿æœŸä¸è§„å¾‹ï¼Œå¯ç»“åˆè®°å½•æƒ…å†µå’¨è¯¢åŒ»ç”Ÿã€‚
        </div>
      `;
      return;
    }

    const nextStart = new Date(lastStart.getTime() + cycleLen*msPerDay);
    const daysToNext = Math.round((nextStart - today)/msPerDay);
    const ovulation = new Date(nextStart.getTime() - 14*msPerDay);
    const daysToOvulation = Math.round((ovulation - today)/msPerDay);

    let html = '';

    if (daysToNext <= 3 && daysToNext >= -3) {
      html += `<div class="small-text" style="margin-bottom:4px;">
        é¢„è®¡ <b>${daysToNext === 0 ? 'ä»Šå¤©' : (daysToNext + ' å¤©å')}</b> å¼€å§‹ç”Ÿç†æœŸï¼Œè¯·æå‰å‡†å¤‡ç»æœŸç”¨å“ï¼Œæ³¨æ„ä¿æš–ä¸ä¼‘æ¯ã€‚
      </div>`;
    } else if (daysToNext > 3 && daysToNext <= cycleLen + 5) {
      html += `<div class="small-text" style="margin-bottom:4px;">é¢„è®¡çº¦ <b>${daysToNext} å¤©å</b> å¼€å§‹ä¸‹ä¸€æ¬¡ç”Ÿç†æœŸã€‚</div>`;
    } else if (daysToNext < -3) {
      html += `<div class="small-text" style="margin-bottom:4px;">
        æœ¬æ¬¡æœˆç»å·²è¶…è¿‡é¢„è®¡æ—¶é—´ï¼Œå¦‚é•¿æœŸæ˜æ˜¾æ¨è¿Ÿï¼Œå¯ç»“åˆè‡ªèº«æƒ…å†µè€ƒè™‘æ˜¯å¦éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥ã€‚
      </div>`;
    }

    if (daysToOvulation >= -2 && daysToOvulation <= 2) {
      html += `<div class="small-text" style="margin-bottom:4px;">
        å½“å‰å¤„äºæ’åµæœŸé™„è¿‘æ˜“å­•çª—å£ã€‚å¦‚ä¸å¤‡å­•ï¼Œè¯·æ³¨æ„æœ‰æ•ˆé¿å­•ï¼›å¦‚æœ‰å¤‡å­•è®¡åˆ’ï¼Œå¯ä»¥é€‚å½“å®‰æ’ã€‚
      </div>`;
    } else if (daysToOvulation > 2 && daysToOvulation <= 7) {
      html += `<div class="small-text" style="margin-bottom:4px;">å¤§çº¦ ${daysToOvulation} å¤©åè¿›å…¥æ’åµæœŸæ˜“å­•çª—å£ã€‚</div>`;
    }

    if (!html) {
      html = '<p class="small-text">æš‚æ— ç‰¹åˆ«æé†’ã€‚è¯·ç»§ç»­ç¨³å®šè®°å½•ï¼Œç³»ç»Ÿä¼šé€æ¸ç”Ÿæˆæ›´å‡†ç¡®çš„æç¤ºã€‚</p>';
    }

    box.innerHTML = html;
  }

  // ========== 6. æœ€è¿‘è®°å½• & æƒ…ç»ªé¢„æµ‹ & å¯è§†åŒ– ==========
  function loadRecentRecordsAndEmotion() {
    if (!currentUid) return;
    const uid = currentUid;
    const ref = db.ref('users/' + uid + '/records');

    ref.orderByChild('timestamp').limitToLast(60).once('value', snap => {
      const recordsDiv = document.getElementById('recent-records');
      const predDiv = document.getElementById('emotion-prediction');
      const chartSummary = document.getElementById('chart-summary');

      if (!snap.exists()) {
        recordsDiv.innerHTML = 'æš‚æ— è®°å½•ã€‚';
        predDiv.innerHTML = 'æš‚æ— è¶³å¤Ÿæ•°æ®ï¼Œè¯·å…ˆè¿ç»­è®°å½•å‡ å¤©çš„æƒ…ç»ªã€‚';
        chartSummary.textContent = 'æš‚æ— æ•°æ®å¯ç»˜å›¾ã€‚';
        if (historyChart) {
          historyChart.destroy();
          historyChart = null;
        }
        return;
      }

      const list = [];
      snap.forEach(child => list.push(child.val()));
      list.sort((a,b) => (a.date > b.date ? 1 : -1));

      let html = '<table><thead><tr><th>æ—¥æœŸ</th><th>æƒ…ç»ª</th><th>å‹åŠ›</th><th>ç¡çœ h</th></tr></thead><tbody>';
      const last10 = list.slice(-10);
      last10.forEach(r => {
        html += `<tr>
          <td>${r.date}</td>
          <td>${r.emotionScore ?? '-'}</td>
          <td>${r.stressScore ?? '-'}</td>
          <td>${r.sleepHours ?? '-'}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      recordsDiv.innerHTML = html;

      updateHistoryChart(list);

      const last7 = list.slice(-7);
      const emoArr = last7.map(r => Number(r.emotionScore || 0)).filter(v => v > 0);
      const stressArr = last7.map(r => Number(r.stressScore || 0)).filter(v => v > 0);
      const sleepArr = last7.map(r => Number(r.sleepHours || 0)).filter(v => v > 0);

      if (emoArr.length < 3) {
        predDiv.innerHTML = 'æœ€è¿‘æƒ…ç»ªè®°å½•ä¸è¶³ 3 æ¡ï¼Œéš¾ä»¥åˆ¤æ–­è¶‹åŠ¿ã€‚è¯·ç»§ç»­è®°å½•å‡ å¤©ã€‚';
        chartSummary.textContent = 'è¯·è‡³å°‘è¿ç»­è®°å½• 3 å¤©ä»¥ä¸Šï¼Œä»¥ä¾¿è§‚å¯Ÿè¶‹åŠ¿ã€‚';
        return;
      }

      const avg = arr => arr.reduce((s,v)=>s+v,0)/(arr.length || 1);
      const emoAvg = avg(emoArr);
      const stressAvg = stressArr.length ? avg(stressArr) : 3;
      const sleepAvg = sleepArr.length ? avg(sleepArr) : 7;

      let level = 'ä¸­ç­‰';
      let reason = `æœ€è¿‘ ${emoArr.length} å¤©çš„æƒ…ç»ªå¹³å‡åˆ†çº¦ä¸º ${emoAvg.toFixed(2)}ï¼Œå‹åŠ›å¹³å‡ä¸º ${stressAvg.toFixed(2)}ï¼Œç¡çœ çº¦ ${sleepAvg.toFixed(1)} å°æ—¶ã€‚`;

      if (emoAvg >= 4 && stressAvg <= 3 && sleepAvg >= 7) {
        level = 'åé«˜';
        reason += ' æ•´ä½“çŠ¶æ€è¾ƒå¥½ï¼Œæ˜å¤©å‡ºç°ç§¯ææƒ…ç»ªçš„å¯èƒ½æ€§è¾ƒå¤§ã€‚';
      } else if (emoAvg <= 2.5 || stressAvg >= 4 || sleepAvg < 6) {
        level = 'åä½';
        reason += ' æƒ…ç»ªæˆ–å‹åŠ›æœ‰ä¸€å®šè´Ÿæ‹…ï¼Œå»ºè®®é€‚å½“æ”¾æ¾ã€ä¿è¯ç¡çœ ï¼Œå¯å°è¯•å†¥æƒ³ / è½»è¿åŠ¨ã€‚';
      }

      predDiv.innerHTML = `
        <div>æ ¹æ®æœ€è¿‘å‡ å¤©æ•°æ®ï¼Œ<b>æ˜æ—¥æƒ…ç»ªæ°´å¹³é¢„æµ‹ï¼š${level}</b></div>
        <div style="margin-top:4px;">${reason}</div>
        <div class="small-text" style="margin-top:4px;">è¯¥é¢„æµ‹ä»…åŸºäºç®€å•ç»Ÿè®¡è§„åˆ™ï¼Œä¸æ„æˆå¿ƒç†æˆ–åŒ»ç–—å»ºè®®ã€‚</div>
      `;

      chartSummary.innerHTML = `
        æœ€è¿‘ ${list.length} æ¬¡è®°å½•ä¸­ï¼Œæƒ…ç»ªä¸å‹åŠ›æ•´ä½“å‘ˆç° <b>${level}</b> æ°´å¹³ã€‚
        å¯ç»“åˆå›¾è¡¨è§‚å¯Ÿã€Œå‹åŠ›é«˜ + ç¡çœ å°‘ã€çš„æ—¥æœŸï¼Œå°è¯•ä¸ºè‡ªå·±å®‰æ’æ›´å¤šæ¢å¤æ—¶é—´ã€‚
      `;
    });
  }

  function updateHistoryChart(list) {
    const ctx = document.getElementById('historyChart').getContext('2d');
    const labels = list.map(r => r.date);
    const emoData = list.map(r => r.emotionScore ?? null);
    const stressData = list.map(r => r.stressScore ?? null);
    const sleepData = list.map(r => r.sleepHours ?? null);

    if (historyChart) {
      historyChart.destroy();
    }

    historyChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'æƒ…ç»ªè¯„åˆ†',
            data: emoData,
            borderColor: '#9b6bff',
            backgroundColor: 'rgba(155,107,255,0.12)',
            tension: 0.25,
            yAxisID: 'y'
          },
          {
            label: 'å‹åŠ›æŒ‡æ•°',
            data: stressData,
            borderColor: '#ff9f1c',
            backgroundColor: 'rgba(255,159,28,0.12)',
            tension: 0.25,
            yAxisID: 'y'
          },
          {
            label: 'ç¡çœ æ—¶é•¿ï¼ˆå°æ—¶ï¼‰',
            data: sleepData,
            borderColor: '#2ed573',
            backgroundColor: 'rgba(46,213,115,0.12)',
            borderDash: [4,2],
            tension: 0.25,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        stacked: false,
        plugins: {
          legend: {
            labels: {
              font: { size: 11 }
            }
          }
        },
        scales: {
          y: {
            type: 'linear',
            position: 'left',
            suggestedMin: 0,
            suggestedMax: 5,
            title: { display: true, text: 'æƒ…ç»ª / å‹åŠ›ï¼ˆ1~5ï¼‰' }
          },
          y1: {
            type: 'linear',
            position: 'right',
            suggestedMin: 0,
            suggestedMax: 10,
            grid: { drawOnChartArea: false },
            title: { display: true, text: 'ç¡çœ æ—¶é•¿ï¼ˆå°æ—¶ï¼‰' }
          }
        }
      }
    });
  }

  // ========== 7. ç”Ÿæˆâ€œå¥³æ€§ç”Ÿç†å¥åº·å»ºè®®â€ ==========
  function buildAdviceHTML(profile, record) {
    const parts = [];
    parts.push(`<p>åŸºäºä½ ä»Šå¤©çš„è®°å½•ï¼ˆæ—¥æœŸï¼š<b>${record.date}</b>ï¼‰ã€å‘¨æœŸå‚æ•°å’Œè¿‘æœŸçŠ¶æ€ï¼Œä»¥ä¸‹å»ºè®®ä»…ä¾›è‡ªæˆ‘è§‚å¯Ÿä¸å‚è€ƒã€‚</p>`);

    if (record.onPeriod === 'æ˜¯') {
      parts.push('<p><b>ç»æœŸæŠ¤ç†ï¼š</b>ä»Šå¤©å¤„äºç»æœŸï¼Œè¯·æ³¨æ„ä¿æš–ï¼Œé¿å…è…¹éƒ¨å—å‡‰å’Œè¿‡åº¦åŠ³ç´¯ã€‚å¯é€‚å½“è¿›è¡Œè½»æŸ”æ‹‰ä¼¸æˆ–æ•£æ­¥ï¼Œæœ‰åŠ©äºç¼“è§£ä¸é€‚ã€‚</p>');
      if (record.flow === 'è¾ƒå¤š') {
        parts.push('<p>ä½ è®°å½•çš„ç»è¡€é‡åå¤šï¼Œå¦‚è¿ç»­å¤šæ—¥é‡å¤§ã€ä¼´æœ‰æ˜æ˜¾ä¹åŠ›æˆ–å¤´æ™•ï¼Œå»ºè®®ç•™æ„æ˜¯å¦æœ‰è´«è¡€é£é™©ï¼Œå¹¶æ ¹æ®éœ€è¦å’¨è¯¢åŒ»ç”Ÿã€‚</p>');
      }
      if (record.symptoms && record.symptoms.includes('ç—›ç»')) {
        parts.push('<p>å‡ºç°ç—›ç»æ—¶ï¼Œå¯å°è¯•çƒ­æ•·ä¸‹è…¹éƒ¨ã€ä¿æŒæƒ…ç»ªç¨³å®šï¼Œé¿å…è¿‡åº¦å’–å•¡å› å’Œè¾›è¾£é¥®é£Ÿã€‚å¦‚ç–¼ç—›æŒç»­ä¸¥é‡ä¸”å½±å“ç”Ÿæ´»ï¼Œå¯è€ƒè™‘ä¸“ä¸šå°±åŒ»è¯„ä¼°ã€‚</p>');
      }
    } else {
      parts.push('<p><b>éç»æœŸè§‚å¯Ÿï¼š</b>ç›®å‰ä¸åœ¨ç»æœŸï¼Œå¯å…³æ³¨ç™½å¸¦ã€æƒ…ç»ªã€ç¡çœ ä¸èƒ½é‡æ°´å¹³çš„å˜åŒ–ï¼Œä¸ºä¸‹ä¸€ä¸ªå‘¨æœŸä½œå‡†å¤‡ã€‚</p>');
    }

    if (record.emotionScore != null) {
      if (record.emotionScore <= 2) {
        parts.push('<p><b>æƒ…ç»ªå…³æ€€ï¼š</b>ä»Šå¤©æ•´ä½“æƒ…ç»ªè¯„åˆ†åä½ï¼Œå¯ä»¥ç»™è‡ªå·±å¤šä¸€ç‚¹ä¼‘æ¯ä¸ç¼“å†²æ—¶é—´ã€‚å»ºè®®å®‰æ’ä¸€äº›è®©è‡ªå·±æ”¾æ¾çš„æ´»åŠ¨ï¼Œå¦‚æ•£æ­¥ã€å¬èˆ’ç¼“éŸ³ä¹æˆ–è¿›è¡Œç®€å•å†¥æƒ³ã€‚</p>');
      } else if (record.emotionScore >= 4) {
        parts.push('<p><b>æƒ…ç»ªè¡¨ç°è‰¯å¥½ï¼š</b>ä»Šå¤©æƒ…ç»ªçŠ¶æ€è¾ƒå¥½ï¼Œå¯ä»¥é€‚å½“å®‰æ’å­¦ä¹  / å·¥ä½œé‡ç‚¹ä»»åŠ¡ï¼Œä¹Ÿåˆ«å¿˜äº†ä¿ç•™ä¸€ç‚¹â€œç•™ç™½æ—¶é—´â€ç…§é¡¾è‡ªå·±ã€‚</p>');
      }
    }
    if (record.stressScore != null && record.stressScore >= 4) {
      parts.push('<p>ä½ çš„å‹åŠ›æŒ‡æ•°åé«˜ï¼Œå»ºè®®å°è¯•å°†ä»»åŠ¡æ‹†åˆ†æˆå°æ­¥éª¤ï¼Œåˆç†å®‰æ’èŠ‚å¥ï¼›å¿…è¦æ—¶å¯ä»¥ä¸ä¿¡ä»»çš„äººï¼ˆæœ‹å‹ã€å®¶äººã€è€å¸ˆç­‰ï¼‰åˆ†äº«å‹åŠ›æ„Ÿå—ã€‚</p>');
    }

    if (record.sleepHours != null) {
      if (record.sleepHours < 6) {
        parts.push('<p><b>ç¡çœ æé†’ï¼š</b>æ˜¨æ™šç¡çœ æ—¶é•¿åçŸ­ï¼ˆå°‘äº 6 å°æ—¶ï¼‰ï¼Œé•¿æœŸç¡çœ ä¸è¶³ä¼šåŠ é‡æƒ…ç»ªæ³¢åŠ¨å’Œç»æœŸä¸é€‚ã€‚å»ºè®®å°½å¯èƒ½ä¿è¯ 7 å°æ—¶å·¦å³çš„é«˜è´¨é‡ç¡çœ ã€‚</p>');
      } else if (record.sleepHours >= 7 && record.sleepHours <= 9) {
        parts.push('<p>ä½ çš„ç¡çœ æ—¶é•¿åœ¨ç›¸å¯¹ç†æƒ³èŒƒå›´ï¼ˆçº¦ 7â€“9 å°æ—¶ï¼‰ï¼Œå¯ä»¥ç»§ç»­ä¿æŒè‰¯å¥½çš„ä½œæ¯èŠ‚å¾‹ã€‚</p>');
      }
    }

    if (record.dietType === 'é«˜è„‚ / æ²¹ç‚¸' || record.dietType === 'åç”œ') {
      parts.push('<p><b>é¥®é£Ÿå»ºè®®ï¼š</b>ä»Šå¤©çš„é¥®é£Ÿåæ²¹æˆ–åç”œï¼Œå»ºè®®åœ¨ç»æœŸåŠæ’åµé™„è¿‘é€‚åº¦æ§åˆ¶æ­¤ç±»é£Ÿç‰©ï¼Œå¤šé€‰æ‹©æ¸…æ·¡ã€é«˜çº¤ç»´ã€é«˜è›‹ç™½çš„ç»„åˆï¼Œæœ‰åŠ©äºè¡€ç³–ç¨³å®šå’Œæƒ…ç»ªå¹³ç¨³ã€‚</p>');
    } else if (record.dietType === 'æ¸…æ·¡' || record.dietType === 'é«˜è›‹ç™½') {
      parts.push('<p>ä»Šå¤©çš„é¥®é£Ÿè®°å½•ç›¸å¯¹å¥åº·ï¼Œæœ‰åˆ©äºä½“é‡ç®¡ç†å’Œæ¿€ç´ å¹³è¡¡ï¼Œå¯ä»¥ç»§ç»­ä¿æŒã€‚</p>');
    }

    if (record.waterMl != null && record.waterMl < 1200) {
      parts.push('<p><b>è¡¥æ°´æç¤ºï¼š</b>ä»Šæ—¥é¥®æ°´é‡ç•¥å°‘ï¼Œå»ºè®®é€‚å½“å¢åŠ æ¸©æ°´æˆ–æ·¡èŒ¶æ‘„å…¥ï¼Œæœ‰åŠ©äºç¼“è§£ç–²åŠ³ä¸å¤´ç—›ç­‰ä¸é€‚ã€‚</p>');
    }

    if (record.exerciseMin != null) {
      if (record.exerciseMin >= 30) {
        parts.push('<p>ä½ ä»Šå¤©å®Œæˆäº†è¾ƒå……è¶³çš„è¿åŠ¨ï¼ˆâ‰¥30 åˆ†é’Ÿï¼‰ï¼Œæœ‰åŠ©äºæå‡å¿ƒæƒ…å’Œç¡çœ è´¨é‡ã€‚ä½†ç»æœŸæ—¶ä»è¦é¿å…è¿‡åº¦å‰§çƒˆçš„è®­ç»ƒã€‚</p>');
      } else if (record.exerciseMin > 0 && record.exerciseMin < 20) {
        parts.push('<p>ä»Šå¤©çš„è¿åŠ¨æ—¶é—´åå°‘ï¼Œå¯ä»¥è€ƒè™‘å®‰æ’ 10â€“20 åˆ†é’Ÿçš„è½»è¿åŠ¨ï¼Œä¾‹å¦‚æ‹‰ä¼¸ã€æ•£æ­¥æˆ–ç‘œä¼½ï¼Œä»¥ä¿ƒè¿›è¡€æ¶²å¾ªç¯å’Œæ”¾æ¾èº«å¿ƒã€‚</p>');
      }
    }

    if (record.triggers && record.triggers.length > 0) {
      parts.push(`<p><b>æƒ…ç»ªè§¦å‘å› ç´ ï¼š</b>ä½ è®°å½•çš„å¯èƒ½è§¦å‘å› ç´ åŒ…æ‹¬ï¼š${record.triggers.join('ã€')}ã€‚å¯ä»¥å°è¯•ä¸ºå…¶ä¸­ä¸€é¡¹è®¾è®¡ä¸€ä¸ªâ€œå°åº”å¯¹ç­–ç•¥â€ï¼Œä¾‹å¦‚ï¼šä¸ºå·¥ä½œå‹åŠ›è®¾å®šå¯æ§çš„å¾…åŠæ¸…å•ï¼Œä¸ºç¡çœ ä¸è¶³è°ƒæ•´å›ºå®šçš„ä¸ŠåºŠæ—¶é—´ã€‚</p>`);
    }
    if (record.hormoneFeelings && record.hormoneFeelings.length > 0) {
      parts.push(`<p>ä½ æåˆ°çš„æ¿€ç´ ç›¸å…³æ„Ÿå—ï¼ˆå¦‚ï¼š${record.hormoneFeelings.join('ã€')}ï¼‰åœ¨ç»å‰å’Œç»æœŸé˜¶æ®µè¾ƒä¸ºå¸¸è§ã€‚è‹¥è¿™äº›æƒ…å†µæŒç»­å½±å“å­¦ä¹ ã€å·¥ä½œæˆ–äººé™…å…³ç³»ï¼Œå»ºè®®é€‚æ—¶å¯»æ±‚ä¸“ä¸šæ„è§ï¼ˆå¦‡ç§‘æˆ–å¿ƒç†å’¨è¯¢ï¼‰ã€‚</p>`);
    }

    if (profile && profile.cycleLength) {
      const c = Number(profile.cycleLength);
      if (c >= 21 && c <= 35) {
        parts.push(`<p><b>å‘¨æœŸæ•´ä½“æé†’ï¼š</b>ä½ çš„å¹³å‡å‘¨æœŸè®¾ç½®ä¸ºçº¦ ${c} å¤©ï¼Œå±äºå¸¸è§èŒƒå›´ã€‚å»ºè®®åšæŒè®°å½•è‡³å°‘ 3â€“6 ä¸ªæœˆï¼Œä»¥ä¾¿æ›´å‡†ç¡®åœ°è§‚å¯Ÿâ€œå®é™…å‘¨æœŸ vs é¢„æµ‹å‘¨æœŸâ€çš„å·®å¼‚ï¼Œä¸ºåç»­å°±åŒ»æˆ–è‡ªæˆ‘ç®¡ç†æä¾›å‚è€ƒæ•°æ®ã€‚</p>`);
      } else {
        parts.push(`<p><b>å‘¨æœŸä¸è§„åˆ™æç¤ºï¼š</b>ä½ å½“å‰å¡«å†™çš„å¹³å‡å‘¨æœŸçº¦ä¸º ${c} å¤©ï¼Œç•¥è¶…å‡ºå¸¸è§èŒƒå›´ï¼ˆ21â€“35 å¤©ï¼‰ã€‚å»ºè®®æŒç»­è®°å½•ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœé•¿æœŸæ˜æ˜¾ä¸è§„å¾‹ï¼Œå¯ç»“åˆä¸ªäººçŠ¶å†µå’¨è¯¢åŒ»ç”Ÿã€‚</p>`);
      }
    }

    parts.push('<p class="small-text">ä»¥ä¸Šå»ºè®®ä»…åŸºäºä½ å¡«å†™çš„æ•°æ®ä¸ä¸€èˆ¬å¥³æ€§ç”Ÿç†å¥åº·å¸¸è¯†ï¼Œå¹¶ä¸èƒ½æ›¿ä»£ä¸“ä¸šåŒ»ç–—æ„è§ã€‚å¦‚æœ‰æŒç»­ä¸é€‚æˆ–æ˜æ˜¾å¼‚å¸¸ï¼Œè¯·åŠæ—¶å°±åŒ»ã€‚</p>');
    return parts.join('');
  }
</script>
</body>
</html>
